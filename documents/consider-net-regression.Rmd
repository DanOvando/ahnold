---
title: "R Notebook"
output: html_notebook
---

So another idea.... what if you've been making this all wayyyyy too complicated. Couldn't you run the hurdle, and then manually back out the DiD terms in the same way you manually create the bundance indicies?



How then do we incorporate this process into our DiD estimator? We could simply fit two DiD regressions for each part of the delta model, but then how do we create an... hmmm idea here. What if you control for all the stuff and manually back out the neet effect of being a fished species in a given year.... 

```{r}

a <- abundance_indices %>%
  filter(data_source == 'length_to_density',
         population_structure == 'one-pop',
         population_filtering == 'all'
         ) %>%
  select(classcode,data) %>%
  unnest() %>% 
  left_join(annual_regional_conditions, by = c('year','region')) %>% 
    left_join(enso, by = 'year') %>%
  left_join(pdo, by = 'year') %>%
  left_join(ci_catches, by = c('classcode', 'year')) %>% 
    mutate(targeted = (targeted == 'Targeted') %>% as.numeric()) %>%
  mutate(catch = ifelse(is.na(catch), 0, catch),
         post_mpa = year >=2003)



seen_data <- a %>%
  filter(any_seen== T)

seeing_data <- a



# test <- lme4::lmer(log_density ~  targeted*factor_year + site_side + mean_vis +  loo + mean_enso + mean_pdo + lag1_enso + lag2_enso + lag1_pdo + lag2_pdo + catch, data = seen_data)

seen_model <- rstanarm::stan_glmer('log_density ~  targeted + site_side + mean_vis + mean_canopy +  (1|classcode) + (1 | factor_year:targeted) + mean_enso + mean_pdo + lag1_enso + lag2_enso + lag1_pdo + lag2_pdo + catch', data = seen_data, chains = 1)

dids <- seen_model %>%
  broom::tidy() %>%
  filter(str_detect(term,'targeted:')) %>%
  mutate(year = str_replace_all(term,'\\D','') %>% as.numeric())


dids %>%
  ggplot() +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  geom_vline(aes(xintercept = 2003), linetype = 1, color = 'red') +

  geom_pointrange(aes(x = year, y = estimate, ymin =  estimate - 1.96*std.error,
                      ymax = estimate + 1.96*std.error))


# seeing model

```

Try again for seeing data

```{r}

seeing_model <- lme4::lmer(any_seen ~  targeted + post_mpa + targeted:factor_year + site_side + mean_vis + mean_canopy +  (1|classcode) + (1 | factor_year) + mean_enso + mean_pdo + lag1_enso + lag2_enso + lag1_pdo + lag2_pdo + catch, data = seeing_data)

dids <- seeing_model %>%
  broom::tidy() %>%
  filter(str_detect(term,'targeted:')) %>%
  mutate(year = str_replace_all(term,'\\D','') %>% as.numeric())


dids %>%
  ggplot() +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  geom_vline(aes(xintercept = 2003), linetype = 1, color = 'red') +

  geom_pointrange(aes(x = year, y = estimate, ymin =  estimate - 1.96*std.error,
                      ymax = estimate + 1.96*std.error))

```


```{r}

seen_aug <- broom::augment(seen_model)


seen_factors <- colnames(seen_aug)[map_lgl(seen_aug, ~class(.x) == 'factor' |class(.x) == 'character')]

top_factors <- seen_aug %>%
  group_by_at(vars(one_of(seen_factors[seen_factors != 'factor_year']))) %>%
  count() %>%
  arrange(desc(n)) %>%
  ungroup() %>%
  slice(1) %>%
  select(-n)

seen_series <- seen_aug %>%
  purrrlyr::dmap_if(is.character, as.factor)

factor_names <- colnames(top_factors)

for (i in factor_names){ # filter down to the most common thing

  where_seen <- (seen_series[,i] == (top_factors[,i][[1]]))

  seen_series <- seen_series[where_seen,]

}

seen_series <- seen_series %>%
  slice(1)

if (class(seen_model) == 'lmerMod'){

  num_original_years <- seen_model@flist$factor_year %>% unique()

  seen_series <- seen_series[rep(1, length(num_original_years)),] #replicate the number of years

  seen_series$factor_year <- levels(num_original_years) %>% as.factor()

} else {
num_original_years <- seen_model$xlevels$factor_year

seen_series <- seen_series[rep(1, length(num_original_years)),] #replicate the number of years

seen_series$factor_year <- seen_model$xlevels$factor_year %>% as.factor()
}


seen_hat <- predict(seen_model, newdata = seen_series)

seeing_hat <- predict(seeing_model, newdata = seen_series, type = 
                        'response')

seeing_hat * did_terms


```

