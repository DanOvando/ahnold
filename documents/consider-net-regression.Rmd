---
title: "R Notebook"
output: html_notebook
---

So another idea.... what if you've been making this all wayyyyy too complicated. Couldn't you run the hurdle, and then manually back out the DiD terms in the same way you manually create the bundance indicies?



How then do we incorporate this process into our DiD estimator? We could simply fit two DiD regressions for each part of the delta model, but then how do we create an... hmmm idea here. What if you control for all the stuff and manually back out the neet effect of being a fished species in a given year.... 

```{r}

a <- abundance_models %>%
  filter(data_source == 'supplied_density',
         population_structure == 'one-pop',
         population_filtering == 'all'
         ) %>%
  select(classcode,data) %>%
  unnest()

seen_data <- a %>%
  filter(any_seen== T) %>%
  # mutate(targeted = (targeted == 'Targeted') %>% as.numeric()) %>%
  left_join(ci_catches, by = c('classcode', 'year')) %>%
  mutate(catch = ifelse(is.na(catch), 0, catch),
         post_mpa = year >=2003)


test <- lme4::lmer(log_density ~  targeted + post_mpa +targeted:factor_year + region + mean_vis + linf
             mean_enso + mean_pdo + lag1_enso + lag2_enso + lag1_pdo + lag2_pdo + (1|factor_year) -1, data = seen_data)

dids <- test %>%
  broom::tidy() %>%
  filter(str_detect(term,'targeted:')) %>%
  mutate(year = str_replace_all(term,'\\D','') %>% as.numeric())


dids %>%
  ggplot() +
  geom_pointrange(aes(x = year, y = estimate, ymin =  estimate - 1.96*std.error,
                      ymax = estimate + 1.96*std.error))


summary(test)

```

Try again for seeing data
```{r}

seeing_data <- a %>%
  mutate(targeted = (targeted == 'Targeted') %>% as.numeric()) %>%
  left_join(enso, by = 'year') %>%
  left_join(pdo, by = 'year') %>%
  left_join(ci_catches, by = c('classcode', 'year')) %>%
  mutate(catch = ifelse(is.na(catch), 0, catch),
         post_mpa = year >=2003)




test2 <- glm(any_seen ~  targeted + post_mpa +targeted:factor_year + region + mean_vis + factor_month +
             trunc_observer + cumulative_n_obs + level + surge  +
             mean_enso + mean_pdo + lag1_enso + lag2_enso + lag1_pdo + lag2_pdo , data = seeing_data, family = 'binomial')

dids <- test2 %>%
  broom::tidy() %>%
  filter(str_detect(term,'targeted:')) %>%
  mutate(year = str_replace_all(term,'\\D','') %>% as.numeric())


dids %>%
  ggplot() +
  geom_pointrange(aes(x = year, y = estimate, ymin =  estimate - 1.96*std.error,
                      ymax = estimate + 1.96*std.error))

```

