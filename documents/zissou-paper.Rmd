---
title: "Predicting and Detecting the Regional-Scale Conservation Impacts of Marine Protected Areas"
author: "Dan Ovando"
output: 
  bookdown::pdf_document2:
  bookdown::html_document2:
bibliography: dissertation.bib
linkcolor: blue
biblio-style: apalike
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r options}
library(sf)
library(viridis)
library(hrbrthemes)
library(scales)
library(patchwork)
library(rpart)
library(extrafont)
library(tidyverse)
extrafont::loadfonts()

functions <- list.files(here::here("functions"))

walk(functions, ~ here::here("functions", .x) %>% source()) # load local functions

sim_years <- 50

burn_years <- 20

num_patches <- 25


  zissou_theme <- theme_ipsum(base_size = 10, axis_title_size = 14, strip_text_size = 14)

  theme_set(zissou_theme)
  

  samps <- 20000
 
  run_name <- "v3.0"

run_dir <- here::here("results", run_name)

experiment_dir <- here::here("results",run_name, "experiments")

load(file = here::here("results",run_name, "rawish_zissou_data.Rdata"))

load(file = here::here("results",run_name, "model_runs.Rdata"))

load(file = here::here("results",run_name,"processed_grid.Rdata"))

base_run <- model_runs %>% 
  filter(var_names == "a", mpa_only == FALSE, center_scale == TRUE)
  

fitted_data <- base_run$data[[1]]

ahnold_fit <- base_run$tmb_fit[[1]]

report <- base_run$tmb_fit[[1]]$ahnold_estimates

site_data <- read_csv(here::here("data",'Final_Site_Table_UCSB.csv')) %>%
  magrittr::set_colnames(., tolower(colnames(.))) %>%
  select(
    site,
    side,
    mpagroup,
    mpa_status,
    reserve,
    region,
    year_mpa,
    mpaareanm2,
    lat_wgs84,
    lon_wgs84
  ) %>%
  rename(lat_wgs84 = lon_wgs84,
         lon_wgs84 = lat_wgs84) %>%
  unique() %>%
  mutate(eventual_mpa = (year_mpa > 0))


 seen_non_nested_betas <- ahnold_fit$ahnold_estimates %>%
   filter(variable == "seen_non_nested_betas") %>%
   rename(group = variable) %>%
   mutate(variable  = ahnold_fit$seen_cdata$x_non_nested %>% colnames())

 seeing_non_nested_betas <- ahnold_fit$ahnold_estimates %>%
   filter(variable == "seeing_non_nested_betas") %>%
   rename(group = variable) %>%
   mutate(variable  = ahnold_fit$seen_cdata$x_non_nested %>% colnames())

 seen_year_species_betas <- ahnold_fit$ahnold_estimates %>%
   filter(variable == "seen_year_species_betas") %>%
   rename(group = variable) %>%
   mutate(variable = ahnold_fit$seen_cdata$x_year_species %>% colnames())

 seeing_year_species_betas <- ahnold_fit$ahnold_estimates %>%
   filter(variable == "seeing_year_species_betas") %>%
   rename(group = variable) %>%
   mutate(variable = ahnold_fit$seen_cdata$x_year_species %>% colnames())

 seen_region_cluster_betas <- ahnold_fit$ahnold_estimates %>%
   filter(variable == "seen_region_cluster_betas") %>%
   rename(group = variable) %>%
   mutate(variable = ahnold_fit$seen_cdata$x_region_cluster %>% colnames())

 seeing_region_cluster_betas <- ahnold_fit$ahnold_estimates %>%
   filter(variable == "seeing_region_cluster_betas") %>%
   rename(group = variable) %>%
   mutate(variable = ahnold_fit$seen_cdata$x_region_cluster %>% colnames())

 did_betas <- ahnold_fit$ahnold_estimates %>%
   filter(variable == "mpa_effect") %>%
   mutate(group = variable) %>%
   mutate(year = fitted_data$year %>% unique())


 betas <- bind_rows(
   seen_non_nested_betas,
   seeing_non_nested_betas,
   seen_year_species_betas,
   seeing_year_species_betas,
   seen_region_cluster_betas,
   seeing_region_cluster_betas,
   did_betas %>% select(-year)
 ) %>%
   as_data_frame()

 non_nested_beta_plot <- betas %>%
   filter(str_detect(group, "non_nested")) %>%
   ggplot() +
   geom_hline(aes(yintercept = 0), linetype = 2, color = "red") +
   geom_pointrange(aes(x = variable,
                       y = estimate,
                       ymin = lower,
                       ymax = upper)) +
   facet_wrap(~group) +
   coord_flip() +
   theme(axis.text.y = element_text(size = 10))


 year_species_effects_plots <- betas %>%
   filter(str_detect(group, "year_species_betas")) %>%
   mutate(year = str_replace_all(variable,"\\D","") %>% as.numeric()) %>%
   mutate(classcode = str_split(variable,'-', simplify = T)[,2]) %>%
   ggplot() +
   geom_hline(aes(yintercept = 0), linetype = 2, color = "red") +
   geom_ribbon(aes(x = year, ymin = lower, ymax = upper, fill = classcode), alpha = 0.25) +
   geom_line(aes(x = year, y = estimate, color = classcode)) +
   facet_wrap(~group)

  region_cluster_plots <- betas %>%
   filter(str_detect(group, "region_cluster_betas")) %>%
   mutate(cluster = str_replace_all(variable,"\\D","")) %>%
   mutate(region = str_split(variable,'-', simplify = T)[,3]) %>%
   ggplot() +
    geom_hline(aes(yintercept = 0), linetype = 2, color = "red") +
    geom_pointrange(aes(x = region,
                        y = estimate,
                        ymin = lower,
                        ymax = upper, color = cluster)) +
    facet_wrap(~group)



 did_plot <- did_betas %>%
   ggplot() +
   geom_vline(aes(xintercept = 2003), color = 'red', linetype = 2, size = 2) +
 geom_hline(aes(yintercept = 0)) +
   geom_pointrange(aes(
     year,
     y = estimate,
     ymin = lower,
     ymax = upper
   ),
   size = 1.5) +
   labs(x = "Year", y = "Targeted Trend Divergence")



```

# Key questions

- How deep down the simulation testing rabbit hole?

- How to talk about coefficients?

- "Regional" term?

- How big of a problem are synthetic controls?

# Abstract


# Introduction

Insert punchy statement about fisheries and people that isn't the same as every other one. 

## What do We Expect from MPAs?

Marine Protected Areas (MPAs, which we will define here as spatial regions in the ocean in which some or all forms of fishing are prohibitied) have a long history in the management of marine resources. Traditional cultures in Oceania utilized (often temporary) MPAs as a sort of "fish bank" for times of need [@Johannes1978]. In more recent times, MPAs were first (XX) put in place primarily as conservation areas, analogs to terrestrial parks deigned to protect iconic landscapes such as Yellowstone or Kruger National Parks. However, over time our goals and expectations for MPAs have evolved; we now frequently consider the use of MPAs to both protect marine ecosystems within their boundaries and bolster fish populations and fishing opportunities in their surrounding waters.  

As our desired outcomes from MPAs have increased, so too has the complexity of understanding what the magnitude of these "spillover" benefits may be. We have clear and compelling evidence that well enforced MPAs provide conservation benefits within their border [@Lester2009;@Halpern2003; @Edgar2014]. However, the evidence for spillover benefits is far less complete. There is some evidence for spillover of adults and larvae to areas outside of MPAs, but the evidence is far from clear and generally lack controls. Similarly, little empirical evidence exists documenting the fishery spillover of MPAs XX FILL THIS IN MORE  [@Starr2015; @Caselle2015; @Kay2012; McClanahan2000;@Gell2003;@Roberts2001a]. This lack of clarity what we can call the regional-level effects of MPAs (i.e. the net effects of MPAs looking both inside and outside their borders) should not be surprising; the degree and nature of spillover benefits will clearly depend on a host of enabling conditions. A massive MPA covering nearly all of a severely overfished region will almost certainly have huge conservation benefits throughout the region. An MPA of any size placed in a barely fished region will have little added benefit. 

As stakeholders around the world increasinly seek to use MPAs in the marine resource management portfolios, It is critically important that we develop a better understanding of the magnitude and drivers of regional-scale MPA effects. To address this gap, this paper examines two critical questions: 1) What to we expect the regional-scale conservation effects of MPAs to be and 2) When (and how) can we expect to detect these effects?

## What Does Theory Tell Us?

Before we start, we should define "regional-scale conservation MPA effects" for the purposes of this paper. We define regional-scale conservation MPA effects as the change in total abundance of fish (summing inside and outside of MPAs) relative to the total abundance fish that would have occured without the MPA In clearer words, how many more or less fish are there throughout the study region as a result of one or more MPAs? We should that defining "regional" is not a clear-cut exercise. Regional could be defined as a bio-geographic area (e.g. the Channel Islands), or as the range of a population (in line the a fisheries definition of a "stock"). XX what's our solution to thisXX

With that definition in mind, what does basic theory suggest should be the magnitude of these effects? On one hand, if we imagine a region that has driven its fish populations to near extinction which then places 100% of its waters inside a no-take MPA, we would expect the regional-scale conservation effects to be massive, and in fact to approach infinity (in terms of percentage increase) the closer the "pre MPA" popualtions approach zero (assuming that the populations are not so depleted as to prevent recovery). On the other hand, If we place an MPA in place for a lightly fished sedentary species, and in doing so displace a large amount of fishing effort to the waters outside the MPA, it is actually possible to create a net conservation loss. So, this extremely helpful exercise tells us that regardless of almost any other factor, the range of possible regional-scale conservation effects (on a percentage scale) spans sometihng on the order of negative something to infitity. 

However, within these highly informative bounds XX, numerous other factors can act to affect the regional-scale conservation outcomes of MPAs. These include but are certainly not limited to the scale of adult and larval dispersal relative to the size of the MPAs [@Gaines2003; @Botsford2008], the strength and timing of density dependence in the population (e.g. pre or post settlement), how overfished the population was pre-MPA, and how fishing activity responds to the implementation of the MPAs [@Hilborn2004; @Hilborn1992; @Walters2004; @Hastings2003;@Gerber2003; @Gerber2005; @Hilborn2004a; @Gaines2010]. In addition, even for the same total area of MPAs, the location and spacing of the MPAs can have a profound influence on their cumulative impact through habitat and network effects [@Gaines2010; @Costello2010]. Broadly, a wide range of theory and modeling exercies indicate that the expected effects of MPAs can vary widely and are extremely context dependent [@Fulton2015]. 


At the most "conservation friendly" side of things, we could imagine a group of heavily fished species that are largely sedentary as adults, broadcast larvae throughout the region, have post-settlement density dependence, and have a fishing fleet that exits the fishery in proportion to the area protected inside MPAs. Under these circumstances, the MPAs can be expected to provide a substantial influx of new recruits to the overfished areas outside of the reserve, even as the reserve fills in with adults. At the other end, consider a complex of lightly fished species with relative high adult mobility, pre-settlement density dependence (e.g. at the spawning level), and a fishing fleet that concentrates into the remaining fished areas. Under these circumstances, it will be much more challenging for the MPA to provide substantial conservation benefits. 

@Fulton2015. 

@ICUN2014 for mean size of MPAs, needs updating though


The important outcome of this thought process is an understanding that the net regional conservation effects of MPAs can vary wildly depending on the context of the marine ecosystems and fisheries in which they are placed.  


## What Empirical Evidence Do We Have?

It is beyond the scope of this paper to conduct an exhaustive review of empirical evidence for regional-scale conservation effects of MPAs. However, we present here several pieces of empirical evidence of regional MPA effects to demonstrate the challenges of detection, and variety of detected outcomes, in real-world scenarios XX. We focus here on evidence of the effects of MPAs on abundance of fish beyond their borders, see @Lester2009 for a thorough review of within-MPA effects. Many of the studies that explore the effects of MPA outside of their borders focus on studying gradients of abundance (commonly measured through catch-per-unit-effort (CPUE)) along distances from MPA borders. Presence of negative gradients (decreasing CPUE with distance from MPA border) is taken as evidence of "spillover", or the export of biomass from MPAs to their surrounding fished areas

@Halpern2009 conducted a rigorous meta-analysis of empirical evidence for spillover from MPAs. They find that frequent evidence for spillover from MPAs, but at relatively small spatial scales (on average up to 800m from reserve boundaries). @Gell2003 surveyed empirical evidence for adult and larval spillover from MPAs. They document numerous examples of studies showing decreases in CPUE of adult biomass with distance from MPA borders, commonly attributed to buildup of densitiy inside MPAs and subsequent export of fish biomass, though they also note that evidence for larval spillover is far less clear.

@Russ1996 documents changes in densities or large predatory fish inside and outside of a small marine reserve on Apo Island, Philippines (0.45km long at the time). They report a positive correlation between years of MPA existence and fish densities, but note that up to 8 years of protections were required to detect a significnat gradient in fish densities radiating from the reserve borders. @Russ2003a presents a similar study focused on the surgeonfish *Naso vlamingii*, in which they find dramatic densitiy increases within the reserve, as well as a strong correlational relationship showing catch-per-unit effort of *Naso vlamingii* decreasing with distance from the reserve boundary. 

Turning to Europe, several studies have explored MPA spillover in that region. In a similar manner to @Russ1996, @Harmelin-Vivien2008 assessed gradients in fish density at increasing distances from cores of MPAs as evidence of spillover in the Mediterranean. They report evidence of decreases in biomass densities with distance from MPA borders, though these effects largely dissipated within 100s of meters of MPA boundaries. @Vandeperre2011 conducted a meta-analysis of spillover effects (again measured as CPUE along distance-from-MPA gradients over time) around MPA in Southern Europe. They also document some evidence of declines in CPUE with distance from MPA border, as well as a 2-4% increase in CPUE per year in the fished area following MPA implementation. @Guidetti2007a finds similar results in the region. 


@McClanahan2000 measured spillover effects around the Mombasa Marine Park in Kenya. They also provide evidence of negative CPUE gradients with distance from MPA border, but note that these effecs are highly affected by habitat, environmental, and management variables. They document the largest effects for moderately mobile species (e.g. surgeonfish)

<!-- @Fletcher2014 provides an assessment of the fishery impacts of the Great Barrier Reef. They measured fishing rates and total landings before and after the 28% expansion no-take marine reserves within the greater GBR reserve, relative to selected control sites outside the reserve. Modeling exercise had predicted a 10% increase in catch inside the GBR as a function of the new closures; in fact catches decreased ~35% relative to the reference sites over that time. So, this provides some evidence that a network of reserves did not achieve the model-predicted increases in catch (full disclosure, I haven't had time to dig into their methods much though). -->

<!-- @Hughes2016 provides counterevidence to this -->

Several studies have explored the spillover effects of MPAs along the California coast. @Starr2015 and Caselle et al. @Caselle2015 both document rapid but variable changes in fish densities related to marine reserve networks in the Channel Islands and along the central California coast. @Starr2015 found evidence that densities inside MPAs had increased on average, but effects were variable, and found little substantial changes in densities in control sites outside the reserves. @Caselle2015 found similar results, documenting faster increases of densities of fished species inside reserves than outside, but little change in densities in reference sites. Both of these studies then suggest that spillover benefits may be slow (~10 years) to accrue. @Kay2012 reports strong evidence of spillover of adult lobster from MPAs in the Channel Islands. @Thompson2017 reports increases in abundance of the larvae of fished rockfish species, relative to comparable trends of larval abundance for unfished species, following implementation of rockfish-specific MPAs along the California coast. 

<!-- Galapagos @Buglas2018 -->

<!-- Molloy et al. - 2009 - Effects of marine reserve age on fish populations, @Molloy2009 -->

<!-- @Edgar2014 -->

<!-- @Halpern2009 -->

Taken together then, while a large body of literature has examined the theory for regional-scale MPA effects, very little empirical evidence directly tackles the questions "do MPA cause a net change in regional fish biomass, and if so how much"? Nearly all of the empirical evidence of which we are aware measures regional-scale effects by quantifying measures such as CPUE along distance gradients from MPA borders. These studies by and large conclude that these spillover effects are detectable, but a) can be counfunded by environmental and management variables and b) often dissipate at distances greater than 1km from a reserve border. While these studies are extremely important contributions to our understanding of regional MPA effects, they do not directly address the question of net regional conservation impacts of MPAs. 

## How Can We Detect Regional MPA Effects?

Given that we know that the regional level conservation effects of MPAs can vary dramatically, how can we go about detecting these effects in real systems? Under our definition, the conservation effect reflects the change in abundance resulting from the MPA relative to what would have happened without the MPA. This is a nice clear definition, but unfortunately is effectively impossible for us to truly observe in nature. For the case of assessing the conservation effects of MPAs inside, the gold-standard tends to be before-after-control-impact (BACI) studies (analogous to what is commonly referred to as a difference-in-difference analysis in econometrics). In BACI studies, ideally a set of appropriately matched control and "impact" sites are selected, where the "impact" refers to the eventual implementation of MPAs. Fish abundances in the control and impact sites are monitored for some period of time pre and post MPA, and the effect of the MPA on the impact sites (i.e. inside the MPAs) is the difference in the trends in the control and impact sites. So, if both sites are trending up, but the impact sites are trending up faster than the control sites, this is evidence that the MPA is "working" inside its borders. 

While well designed BACI studies are clearly difficult to succesfully implement, and subejct to their own set of caveats and assumptions, they are also a feasible strategy for robustly estimating within-border MPA conservation effects. However, at the regional scale the task becomes much more complicated. Take for example the Channel Islands region off the coast of California (Fig.\@ref(fig:ci-map)). The Channel Islands is a ecologically diverse region that supports a range of fisheries. A network of MPAs was implemented in the Channel Islands in 2003, with the express goal of both providing conservation and fishery benefits throughout the region (citation). 15 years after their implementation, how can we tell if they succesfully caused an increase in fish abundance throughout the Islands? Following the BACI example above, ideally we would like a carbon copy of the Channel Islands that could be kept MPA-free and monitored pre and post MPA implementation in the "treated" Channel Islands. This is of course impossible; we could perhaps envision utilizing nearby regions as controls, e.g. the mainland coastal waters of the Santa Barbara Channel, but this region is quite different thatn the ecosystems in the Channel Islands (XX improve this section). 

Broadly then, as we seek to understand the regional scale effects of MPAs, and as the size of those regions increases, the harder it becomes to find a practical control for the treated region. As a result, it becomes challenging to determine what post-MPA changes throughout the region are attributable to the MPAs and which to other factors. If abundance continue to trend downwards post-MPA, without a control we cannot truly know whether they might have trended down faster without the MPAs. Or if abundances are trending up, we cannot reliably say that the upward trend is not due to some environmental driver. Regression analysis can help (e.g. statistically controlling for El Niño), but depends on "selection on observables", meaning that in order to interpret the MPA coefficients as causal, we have to assume that we have included all the correct covariates that might also be correlated with the outcome of interest (in this case abundance). 

In econometrics, which is generally concerned with identifying the causal effect of a specific policy or intervention, etc... XX talk about identification strategies...

We have then two broad options for estimating the regional estimate of MPAs in a place like the Channel Islands: We can depend on selection on observables through regression analysis, or we can find an identification strategy. Given the shortcomings of the first approach, we propose an identificaiton strategy building off of @Caselle2015, in which we consider relatively unfished species such as Garibaldi (*Hypsypops rubicundus*) to be "controls" for more heavily fished species such as Blue Rockfish (*Sebastes mystinus*). Under this strategy, our assumption is that unfished species are more or less unaffacted by the implementation of MPAs (unlike the fished species), but that both species are potentially affected by regional environmental trends. In this way, the unfished species can serve as our control for environmentally driven shifts in abundance, allowing us to attempt to better isolate changes in abundance driven by MPAs from changes caused by environmental conditions. 

This is clearly not a perfect control... trophic... but conform to assumptions of nearly all MPA modeling papers. 

With that identification strategy in place, we are still faced with a challenge of estimating the effect in real systems. We know already that the magnitude of MPA effects can vary dramatically, and we have some evidence that the net effect may be relatively small. Marine systems also ofen experience high degrees of environmental variability, and are difficult places to monitor, leading to potentially high levels of both natural variability and observation error. This creates a problem then that we are trying to detect whay may be a relatively small effect in a very noisy system. 

## Project Summary

We are faced with three challenges then in understanding and estimating the likely regional scale conservation impacts of MPAs: 1) Understanding the likely magnitude of regional conservation effects of MPAs, 2) developing an identification strategy to estimate the effect in real systems, and 3) exploring under what circumstances this identification strategy may be effective. This paper address each of these challenges through the following steps. 

We first utilize a spatially explicit, age structured bio-economic model to generate simulations of "true" regional-scale MPA conservation effects under a wide range of plasubible conditions. We then consider, given the range of effect sizes observed in this simulation exercise, under what conditions our proposed identification strategy might be able to realibly detect this true effect. We close with an illustration of this process using data from the Channel Islands to estimate the effect of the network of MPAs put in place there in 2003. The results of this process will illustrate plasubile ranges for the regional conservation effects of MPAs, and demonstrate the challenges of estimating these effects in real life. 


# Results and Discussion

## Simulated MPA Effects

```{r}
outcomes <- processed_grid %>%
  slice(1:samps) %>% 
  unnest() %>% 
  mutate(year = year - burn_years) %>% 
  mutate(years_protected = year - year_mpa + 1) %>% 
  mutate(mpa_effect = pmin(mpa_effect,2)) %>% 
  group_by(experiment) %>% 
  mutate(b0 = `no-mpa`[year == min(year)]) %>% 
  mutate(depletion = 1 - `no-mpa`/b0) %>% 
  ungroup() %>% 
  mutate(pop_effect = (`with-mpa` - `no-mpa`) / b0)

eqo <- outcomes %>% 
  filter(year == max(year))

```


We used our bio-economic model to simulate the regional scale conservation effects of MPAs across 20,000 fisheries spanning a wide range of plausible states of nature, including degrees of larval and adult movement, density dependence, fleet dynamics, and pre-MPA exploitation levels (seem SI for details on the simulation process). For simplicities sake at this point we focus on single species outcomes, though since we do not model species interactions fisheries could be aggregated together to provide multi-specie MPA effects. It is critical to note that we have no current way of assigning probabilities to any of these states of nature, though we have tried to constrain the parameter space to plausible states. Therefore, the results of our simulations suggest simply the number of simulated ways that a given outcome could happen; we do not have any knowledge though if in reality some of these simulated outcomes are individually much more or less likely than others. But, if we assume that the simualted parameter space is a reasonable representation of a range of plausible states of nature, these results provide an indication of the general magnitude of effects that we might expect XX. 

Across this range of scenarios, we see that the median equilibrium MPA effect (percentage change in total biomass) was `r round(100*median(eqo$mpa_effect))`%, with a min of `r round(100*min(eqo$mpa_effect))`% and a max of over `r round(100*max(eqo$mpa_effect))`%XX. We also see that while large percentage increases in biomass can accrue relatively rapidly under some circumstances, increases of over 10% took approximately 10 years to achieve for 50% of the simulated fisheries (Fig.\@ref(fig:trend-effect)). It is also clear from the simulations that even constrained by reasonable states of nature, a vast array of regional conservation MPA effects are possibleThe exact expected MPA effect for a given fishery will depend on a complex set of interactions among fishery variables (XX regression tree analysis?). However, two of the most critical factors affecting the direction and magnitude of the MPA effect are the degree of overfishing present before (and contining after) MPA implementation, and the size of the MPA, and so we focus on the effects of these two variables on regional MPA effects 15 years after MPA implementation. Across our simulated fisheries, the median simulated MPA effect was zero to negative for cases where "small" MPAs (smaller than 25%) were implemented in relatively unexploited fisheries. For moderate depletions (50% to 75%), mpa sizes from 1% to 50% produced MPA effects in the range of 1-10%, while for depletions above 75% MPAs of almost any size produced median MPA effects from 10-100% (Fig.\@ref(fig:f-and-s-plot)). 

```{r trend-effect, fig.cap = "Distribution of simulated regional MPA effects over time (A), and at equilibrium (B)"}

trend_plot <- outcomes %>%
  filter(years_protected >0) %>% 
  ungroup() %>% 
  ggplot(aes(
    years_protected,
    mpa_effect,
    group = years_protected
  )) +
  geom_boxplot() +
  geom_hline(aes(yintercept = 0), linetype = 2, color = "red") +
  scale_y_continuous(labels = scales::percent, name = "Regional MPA Effect") + 
  labs(x = "Years of MPA Protection")

density_plot <- outcomes %>% 
  filter(years_protected > 0, year == max(year)) %>% 
  ggplot(aes(mpa_effect)) + 
  geom_vline(aes(xintercept = 0), linetype = 2, color = "red") +
  geom_density(fill = "steelblue", alpha = 0.75) + 
  theme(axis.text.x = element_blank(), axis.title.x = element_blank(),
        axis.text.y = element_blank(), axis.title.y = element_blank(),
            plot.margin = unit(c(.05, .05, .05, .05), "lines"))


mpa_plots  <- (trend_plot + labs(title = "A")) + (density_plot + coord_flip() + labs(title = "B")) + plot_layout(ncol = 2, widths = c(2, 1))
  
mpa_plots

```


```{r f-and-s-plot, fig.cap = "Median (A) and range (B) MPA effect after 15 years of protection across a range of pre-MPA depletions and MPA sizes"}


a = lm(mpa_effect ~ adult_movement*larval_movement + depletion + mpa_size + factor(density_dependence_form) + density_movement_modifier , data = outcomes)

fit_tree = rpart(
  mpa_effect ~ adult_movement + larval_movement + depletion + mpa_size + factor(density_dependence_form) + density_movement_modifier + factor(density_dependence_form) + density_movement_modifier,
  data = outcomes %>% filter(year == max(year))
)


adult_movement_plot <- outcomes %>% 
  mutate(rounded_am = plyr::round_any(adult_movement,1)) %>% 
  ggplot(aes(rounded_am,mpa_effect , group = rounded_am)) + 
  geom_boxplot()


larval_movement_plot <- outcomes %>% 
  mutate(rounded_lm = plyr::round_any(larval_movement,1)) %>% 
  ggplot(aes(rounded_lm,mpa_effect , group = rounded_lm)) + 
  geom_boxplot()

depletion_plot <- outcomes %>% 
  filter(years_protected == 15) %>% 
  mutate(rounded_dep = plyr::round_any(depletion,.05)) %>% 
  ggplot(aes(rounded_dep, mpa_effect, group = rounded_dep)) + 
  geom_boxplot() + 
  scale_y_continuous(labels = percent, name = 'MPA Effect') + 
  scale_x_continuous(labels = percent, name = "Initial Depletion")

size_plot <- outcomes %>% 
    filter(years_protected == 15) %>% 
  mutate(rounded_size = plyr::round_any(mpa_size,.05)) %>% 
  ggplot(aes(rounded_size, mpa_effect, group = rounded_size)) + 
  geom_boxplot() + 
  scale_y_continuous(labels = percent, name = "MPA Effect") + 
  scale_x_continuous(labels = percent, name = "Range in MPA")

  depletion_and_size_plot <- outcomes %>% 
    filter(years_protected >= 0) %>%
    group_by(experiment) %>% 
    mutate(depletion = plyr::round_any(depletion[years_protected == 0], .1),
           mpa_size = plyr::round_any(mpa_size, .1)) %>% 
    filter(years_protected == 15) %>% 
    group_by(depletion, mpa_size) %>% 
    summarise(median_mpa_effect = median(mpa_effect)) %>% 
    ggplot(aes(depletion, mpa_size, fill = median_mpa_effect)) + 
    geom_raster(interpolate = F) + 
    geom_contour(aes(z = median_mpa_effect)) +
    scale_fill_viridis(labels = percent,
                       guide = guide_colorbar(frame.colour = "black",
                                              frame.linewidth = 1,
                                              barheight = unit(15,"lines")), 
                       name = "MPA Effect") +
  labs(x = "Initial Depletion", y = "Range in MPA") + 
    scale_y_continuous(labels = percent) + 
    scale_x_continuous(labels = percent)
  
  combo_plot <- (depletion_and_size_plot + labs(title = "A")) + ((size_plot + labs(title = "B")) / depletion_plot) * theme(plot.margin = unit(c(.1,.1,.1,.1), units = "lines"),axis.text.x = element_text(size = 12),                                                                        axis.text.y = element_text(size = 12)) + plot_layout(widths = c(2,1))
  
  combo_plot
```



```{r pop-trend-effect, fig.cap = "Distribution of simulated regional MPA effects over time (A), and at equilibrium (B)"}

pop_trend_plot <- outcomes %>%
  filter(years_protected >0) %>% 
  ungroup() %>% 
  ggplot(aes(
    years_protected,
    pmin(1,pop_effect),
    group = years_protected
  )) +
  geom_boxplot() +
  geom_hline(aes(yintercept = 0), linetype = 2, color = "red") +
  scale_y_continuous(labels = scales::percent, name = "Regional MPA Effect") + 
  labs(x = "Years of MPA Protection")

pop_density_plot <- outcomes %>% 
  filter(years_protected > 0, year == max(year)) %>% 
  ggplot(aes(pmin(1,pop_effect))) + 
  geom_vline(aes(xintercept = 0), linetype = 2, color = "red") +
  geom_density(fill = "steelblue", alpha = 0.75) + 
  theme(axis.text.x = element_blank(), axis.title.x = element_blank(),
        axis.text.y = element_blank(), axis.title.y = element_blank(),
            plot.margin = unit(c(.05, .05, .05, .05), "lines"))


pop_mpa_plots  <- (pop_trend_plot + labs(title = "A")) + (pop_density_plot + coord_flip() + labs(title = "B")) + plot_layout(ncol = 2, widths = c(2, 1))
  
pop_mpa_plots

```

```{r pop-f-and-s-plot, fig.cap = "Median (A) and range (B) MPA effect after 15 years of protection across a range of pre-MPA depletions and MPA sizes"}


pop_depletion_plot <- outcomes %>% 
  filter(years_protected == 15) %>% 
  mutate(rounded_dep = plyr::round_any(depletion,.05)) %>% 
  ggplot(aes(rounded_dep, pop_effect, group = rounded_dep)) + 
  geom_boxplot() + 
  scale_y_continuous(labels = percent, name = 'MPA Effect') + 
  scale_x_continuous(labels = percent, name = "Initial Depletion")

pop_size_plot <- outcomes %>% 
    filter(years_protected == 15) %>% 
  mutate(rounded_size = plyr::round_any(mpa_size,.05)) %>% 
  ggplot(aes(rounded_size, pop_effect, group = rounded_size)) + 
  geom_boxplot() + 
  scale_y_continuous(labels = percent, name = "MPA Effect") + 
  scale_x_continuous(labels = percent, name = "Range in MPA")

  pop_depletion_and_size_plot <- outcomes %>% 
    filter(years_protected >= 0) %>%
    group_by(experiment) %>% 
    mutate(depletion = plyr::round_any(depletion[years_protected == 0], .1),
           mpa_size = plyr::round_any(mpa_size, .1)) %>% 
    filter(years_protected == 15) %>% 
    group_by(depletion, mpa_size) %>% 
    summarise(median_mpa_effect = median(pop_effect)) %>% 
    ggplot(aes(depletion, mpa_size, fill = median_mpa_effect)) + 
    geom_raster(interpolate = F) + 
    geom_contour(aes(z = median_mpa_effect)) +
    scale_fill_viridis(labels = percent,
                       guide = guide_colorbar(frame.colour = "black",
                                              frame.linewidth = 1,
                                              barheight = unit(15,"lines")), 
                       name = "MPA Effect") +
  labs(x = "Initial Depletion", y = "Range in MPA") + 
    scale_y_continuous(labels = percent) + 
    scale_x_continuous(labels = percent)
  
  pop_combo_plot <- (pop_depletion_and_size_plot + labs(title = "A")) + ((pop_size_plot + labs(title = "B")) / pop_depletion_plot) * theme(plot.margin = unit(c(.1,.1,.1,.1), units = "lines"),axis.text.x = element_text(size = 12),                                                                        axis.text.y = element_text(size = 12)) + plot_layout(widths = c(2,1))
  
  pop_combo_plot
```



## Detecting MPA outcomes

*Third, collinearity can inflate standard errors of coefficient estimates and make ‘true’ effects harder to detect [@Harrison2018;@Zuur2010]

How in depth do we want to go here (both in the body and in the "SI")? 

At the simplest level, we can do a simple power analysis, thinking about for a given sample size, what is the highest variance that could exist around the mean to detect a given effect size (where "detect" means reject from zero). Somewhat appealing, but really abstract; what's the "sample size" we have (every transect? one per species per year)? What's a "reasonable" variance around the mean effect in a real system?

At the more complex level, I have a simulator built up where observers collect length comps from the data given various degrees of evolving skill etc. Can use it to demonstrate that a) the proposed identification strategy works just great under ideal circumstances, but that b) under even slightly realistic circumstances (stochastic autocorrelated recruitment with environmental forcing, evolving observer skill, different life history) you're back to selection on observables. I think this is probably an important point that warrants fleshing out, but lord is it a pain to fit... 

```{r}

effect_size = expand.grid(
  mean = seq(0.01, 0.25, by = 0.01),
  sample_size = seq(5, 100, length.out = 100),
  cv = seq(.1, 2, length.out = 10)
  ) %>% 
  mutate(sd = mean*cv) %>% 
  mutate(samples = pmap(list(
    mean = mean,
    n = sample_size,
    sd = sd
  ),
  rnorm)) %>% 
  mutate(ttest = map_dbl(samples, ~t.test(.x)$p.value))
  

# effect_size %>% 
#   ggplot(aes(sample_size, ttest, color = sd)) + 
#   geom_point()

```


## Detecting MPA Effects in the Channel Islands

Theory and simulation testing indicate then that while the regional-scale conservation effects of MPAs can range from negative to highly positive, for ranges representative of the size of many MPAs (relative to species ranges, XX) and our best knowledge of current depletion levels in fisheries (XX) we might expect the MPA effect to be on the smaller end of the scale, especially within the first 10 years of existence (0% to +25%). Given this, we can guess *a priori* that the "true" MPA effect will be challenging to isolate from the variation both in the natural system and in the MPA monitoring program. We use data from the Partnership for Interdisciplinary Studies of Coastal Oceans (PISCO) monitoring of the Channel Islands National Marine Sancturary to test our ability to detect the MPA effect in a real world context. PISCO conducts visual underwater SCUBA surveys at a variety of sites inside and outside of MPAs throughout the Channel Islands. At the rawest level, the data are counts of fish in specified length bins along a 30 x 2m transect. These length bins are converted to biomasses, and then densities, by converting length to weights using available allometric data and dividing by the transect area. Our goal then is to estimate the effect of the MPAs on these densities of fish throughout the Channel Islands. 

Our identification strategy for this case study is to use unfished species as our control for unaccounted for environmental trends before and after MPA implementation (in 2003). In short, the model works by estimating the difference in the trends between fished and unfished species post MPA (see nice infographic here). We fit this model using a hierarchichal mixed-effect framework in Template Model Builder [TMB, @Kristensen2016]. The model consists broadly of three levels, the first (starting from the "bottom") being transect-level densities of fish species observed by PISCO, which are standardized into an index of abundance to account for both probability of detection and expected density as a result of both abundance and changes in covariates such as observer skill [see @Maunder2004]. For the second stage, we break the abundance indices into targeted and non-targeted speices (per the classifications in the PISCO data), and estimate the mean trend of each group. In the third step, we estimate the difference in the mean trend between the targeted and non-targeted species, which under the right set of circumstances should reflect the causal effect of the MPAs on the outcome of interest (in this case biomass density of fish) (obviously doesn't control for other factors influencing trend in abundance, i.e. not saying that MPA caused a decrease, but I guess that the MPA wasn't enough to overcome the decrease? need to think through phrasing here).

The "causal interpretation" of the model is as follows then. While individual species in the survey have their own abundance trends, the model assumes that abundance of targeted and non-targeted species each come from a common distribution. Assuming parallel pre-treatment trend (pre-treatment correlation between targeted and non-targeted species is XX, Fig.\@ref(fig:cor-plot)), the trend in the underlying mean abundance of non-targeted species post MPA serves as our control for unobserved environmental variables that could also affect the trends in the mean density of targeted species. So, by this logic, we should see no significant divergence between the targeted and non-targeted trends pre "treatment" (implementation of the MPAs), and then some divergence between the treated group (targeted species) and the non-treated group (non-targeted) post treament (if the treatment has an effect). 

XX How worth it is it to spell this all out so carefully given that the simulation testing shows that this isn't good enough to really call causal; better to spell out what this does at least control for and highlight things that it can't account for, like additional shocks (e.g. fishing changes), a lack of actual parallel trends (or a divergence from parallel trends in a new regime, etc.XX Bottom line, how do you want to talk about these effects, somewhere between better than only selection on observables but certainly not "this was the effect"

```{r}


```


Before examining regression results, we can graphically examine the trends in mean densities for targeted and non-targeted species over time. We centered and scaled the mean annual densities for each species included in the analysis in order to compare the trends across species groups. Grouping the species by targeted and non-targeted status, we see evidence of pre-treatment parallel trends in the abundance indicides, and of a divergence post MPA implementation. Beginning in around 2007 abundances of targeted species appear to start increaseing faster than non-targeted species. However, from 2012 onward abundances of targeted species appear to be declining relative to the trend in the non-targeted species. Not controlling for any other factors that may affect fish abundances, the data suggests a possible increase in targeted species abundance (relative to the "control" trend of the non-targeted species) at first, followed by a decrease in the most recent years (Fig.\@ref(fig:raw-trend)). 



```{r raw-trend, fig.cap="Centered and scaled mean annual density of included species (points) and smoothed means of targeted and non-targeted groups (line) over time"}
base_run$data[[1]] %>% 
  select(year, targeted,classcode, log_density, any_seen) %>% 
  mutate(density = exp(log_density) * any_seen) %>% 
  group_by(classcode,targeted, year) %>% 
  summarise(md = mean(density)) %>% 
  group_by(classcode,targeted) %>% 
  mutate(smd = (md - mean(md)) / sd(md)) %>% 
  ggplot(aes(year, smd, color = targeted == 1, fill = targeted == 1)) + 
  geom_vline(aes(xintercept = 2003), linetype = 2, color = "red") +
  geom_point() +
  geom_smooth()
  
```


We do not detect a significant change in the density of fished species relative to the density of unfished species following the implementation of MPAs in the Channel Islands in 2003 (Fig.\@ref(fig:did-plot)). The mean estimated post MPA implementation divergence between the trends of targeted and non-targeted species was `r round(mean(did_betas$estimate))`, indicating a roughly 0% divergence. However, it is important to note that just because we cannot a reject a hypothesis of zero divergence between the targeted and non-targeted groups does not mean that we have precisely estimated the effect size to be zero. Post implementation, the upper limit of the estimated 95% confidence intervals was `r round(max(did_betas$upper),2)` , and the lower limit was `r round(min(did_betas$lower),2)`.  


```{r did-plot, fig.cap = "Estimated divergence in densities of fished and unfished species in the Channel Islands. MPAs are implement in 2003 (red dashsed line). Estimates are from a regression on log(abundnace), and estimated effects roughyl correspond to percentage changes"}

did_plot

```


## Discussion

- MPAs increasingly pointed to for "regional" benefits

- Robust modeling indicates that regional benefits are highly variable and potentiallly small

- Small effect + natural variability + obs error + lack of effective controls = low probability of empirical detection

- Solutions
  - Reliance on modeling
  - Tailor monitoring towards key predictors of MPA performance
  - Spatial stock assessment (net regional F)
  - Synthetic controls?

- So What?
  - Tempered expectations
  - Integrating MPAs with more direct controls 

## Other MPA benefits

Resilience @ROberts2017

# Methods

## Simulation Model

The simulation model used in this analysis is roughly the same as the one described in @Ovando2016. It is an age structured, spatially explicit, bio-economic model. Recruitment is assumed to have Beverton-Holt dynamics on average, though auto-correlated log-normal recruitment deviates can be specified. The timing of density dependence can be one of five forms presented in @Babcock2011, ranging from independent density dependence in each patch to density dependence in a shated larval stage across patches. The model allows for both adult and larval movement, where larval movement is assumed to follow a Gaussian dispersal kernel based on the distance of each patch to the source patch. Adult movement is also modeled using a Gaussian dispersal kernel, but with the added option of density dependent movement as well. In the adult density dependent movement scenario we calculate the density gradient between each patch and every other patch, where the density gradient is calculated as

$$g_{i,j} = \frac{b_i}{b_i^0} - \frac{b_j}{b_j^0} + 1$$

Where *i* is the source patch and *j* is a sink patch, and $b^0$ is the unfished biomass in a given patch. The density gradient $g_{i,j}$ is used as a multiplicative modifier for the distance-based Gaussian dispersal kernel *d*, so that the net movement *m* of individuals from patch *i* to patches 1:J is

$$m_{i,j} = \frac{d_{i,j}g_{i,j}}{\sum_{1:J}d_{i,j}g_{i,j}} $$

Fishing activity is controlled by a fleet model that can take one of four forms: constant catch, constant effort, supplied catch, and open-access. For the supplied catch scenario, a vector of catches drawn from the California Department of Fish and Game database of landings in the Santa Barbara Channel region. For the open-access scenario, we model effort through a profit-response function, where profits are calculated per

$$profits_{t} \sim p_{t}q_{t}E_{t}B^{c}_{t} - c_{t}E_{t}^{\beta}$$

And then effort is modeled as 

$$effort_{t} = effort_{t-1} + effort_{msy}(\theta\frac{profits_{t-1}}{profits_{msy}})$$

The operating model allows for time-varying and autocorrelated deviations in prices *p*, cost *c*, and catchability *q*. 

For all fleet model scenarios, effort is distributed in space in one of three manners: equally, weighted by commercial biomass in each patch, and weighted by historic profits in each patch. 

MPAs are implemented in the operating model by setting a specified percentage of the patches to be placed in a no-take MPA. Patches are then assigned to an MPA eitehr in a linear fashion (left to right) or assigned at random throughout the patches. In all scenarios MPAs are implemented halfway through the simulated time series (allowing the pre-MPA fishing mortality to deplete the popualtion to a desired level beforehand).


Using this operating model, we simulated MPA effects accross XX number of fisheries, where the MPA effect is modeled by running the exact same fishery simulation with and without MPAs, and then calculating the difference in biomass in each year between the two scenarios (setting identical seeds for each simulation). The range of evaluated scenarios is presented in Table.XX

XX insert table of model runs XX


## Regression Analysis


```{r}

filter_summary <- fitted_data %>% 
  select(classcode, targeted) %>% 
  unique() %>% 
  group_by(targeted) %>% 
  count() %>% 
  ungroup() %>% 
  mutate(targeted = ifelse(targeted == 1,"yes","no")) %>% 
  spread(targeted, n)
```

The regression analysis is a mixed-effects hierarchichal model. The raw data are estimated length compositions by species along a transect at a site. Lengths are converted to biomass per allometric relationshisp supplied by PISCO (see SI for summaries of the raw data). We performed some minimal data filtering to reduce noise in the data. We only include species that were observed at least twice in each year of the dataset (2000-2017) somewhere in the core(XX) Channel Islands (Anacapa, Santa Cruz, Santa Rosa, San Miguel). While some data are available from 1999, per consultation with PISCO we ommit those data due to changes in survey protocols. This filtering process results in `r filter_summary$no` non-targeted species and `r filter_summary$yes` targeted species remaining in the analysis. 

The first stage of the regression is a delta log-normal hurdle model. The model estimates two regressions, the first is a logit glm estimating the probability of observing a given fish species at a observation *i* (transect at time *t*. The likehlihood for whether a given species was observed *o* at a given observation is distributed

$$o_{s,i} \sim binomial(\frac{1}{1 +e^{-\beta^{o}{X}}}) $$
 where $\beta^{o}$ are the estimated coefficients for the observation model and *X* is a matrix of covariates that include random effects for each year in the data (2000 to 2017). The expected density *d* of positive observations is modeled per a log-normal distribution
 
 $$log(d_{s,i}) \sim normal(\beta^{d}X, \sigma_s)$$

where $\beta^{d}$ are the estimated coefficients for the expected density model and *X* is the same vector of covariates as used in the observation portion of the model. 

X contains both fixed and random effects. Fixed effects include the level of the transect, the month of the observation, the estimated surge at the transect, the canopy cover at the transect, the depth of the transect, and the experience (and experience squared) of the diver conducting the transect. We classify each species into one of two clusters based on the mean longitude the species was encountered at, breaking the species into two groups: those primarily found in the western end of the Channel Islands those found more in the eastern end.  We then estimate random effects for each island for each cluster

$$\beta_{island,cluster} \sim normal(0,\sigma_{cluster})$$

This allows the mean effect of each island to differ for each cluster. 

The second critical component of X are random effects for each year for each species

$$\beta_{year,species} \sim normal(0,\sigma_{species})$$

These $\beta_{year,species}$ represent our "standardized" estimate of observed abundance of each species in each time step, controlling for the included covariates. 

However, we still need to account for changes in the probability of detection over time. For that, we create a standard matrix of dimensions rows(X) and columns(Y), holding everything fixed at mean (or most frequently observed level for factors) levels for all variables except for year and species. Calling this standardized matrix $X^{standard}$, the probability of observing a given species in year *y* is then

$$p_{s,y} = (\frac{1}{1 +e^{-\beta^{o}{X^{standard}}}})$$

The standardized index of abundance for species *s* in year *y* then is

$$I_{species,year} = p_{species,year}e^{\beta_{species,year}}$$


The next phase of the model requires us to estimate the mean abundance of targeted and non-targeted species over time. T


 $$log(I_{species,year}) \sim normal(\beta^{effect}X^{effect}, \sigma_s)$$

$X^{effect}$ contains both fixed and random effects. The fixed effects include an intercept and the temperature deviation for a given species in a year, where temperature deviation is

$$t_{s,y} = (t^{pref}_{s} -  \bar{t_{y}})^2$$

where $t^{pref}$ is the preferred temperature for species *s* (drawn form `FishLife`, @Thorson2017), and $\bar{t_{y}}$ is the mean temperature encountered by that species in year *y*. We also include random effects for each species in $X^{effect}$. The most important random effects are year effects for targeted and non-targeted species

$$\beta_{year,targeted} \sim normal(0,\sigma_{targeted})$$

$\beta_{year,targeted}$ is the mean log density of targeted species in year *y*, controlling for included covariates. Therefore, the final step in the model, the divergence in the standardized abundance trends of targeted and non-targeted species is

$$divergence_{year} =  \beta_{year,targeted = 1} - \beta_{year,targeted = 0}$$

The model is fit in TMB to integrate the uncertainty across all levels of the model. 

```{r fe-plot, fig.cap = "Estimated coefficients for fixed effects in observation model (seeing) and observed model (seen)"}

 non_nested_beta_plot <- betas %>%
   filter(str_detect(group, "non_nested")) %>%
   ggplot() +
   geom_hline(aes(yintercept = 0), linetype = 2, color = "red") +
   geom_pointrange(aes(x = variable,
                       y = estimate,
                       ymin = lower,
                       ymax = upper)) +
   facet_wrap(~group) +
   coord_flip() +
   theme(axis.text.y = element_text(size = 10))

non_nested_beta_plot

```


```{r region-plot, fig.cap="Random effects for region by cluster"}

  region_cluster_plots <- betas %>%
   filter(str_detect(group, "region_cluster_betas")) %>%
   mutate(cluster = str_replace_all(variable,"\\D","")) %>%
   mutate(region = str_split(variable,'-', simplify = T)[,3]) %>%
   ggplot() +
    geom_hline(aes(yintercept = 0), linetype = 2, color = "red") +
    geom_pointrange(aes(x = region,
                        y = estimate,
                        ymin = lower,
                        ymax = upper, color = cluster)) +
    facet_wrap(~group)

region_cluster_plots

```


```{r targ-plot, fig.cap = "Trends in standardized mean abundance of targeted and non-targeted species"}

targeted_trends <- report %>% 
  filter(str_detect(variable, "targeted_did")) %>% 
  group_by(variable) %>% 
  mutate(year = unique(fitted_data$year)) %>% 
  ungroup() %>% 
  ggplot() + 
  geom_line(aes(year, estimate, color = variable),alpha = 0.5) +
  geom_pointrange(aes(year, estimate, ymin = lower, ymax = upper, color = variable))

targeted_trends

```


# Supplementary Materials

## Regression Diagnostics



```{r}

fit_report <- base_run$tmb_fit[[1]]$ahnold_report

observed_seen <- base_run$tmb_fit[[1]]$zissou_data$log_density
  
observed_seeing <- base_run$tmb_fit[[1]]$zissou_data$any_seen

seen_diagnostics <- data_frame(observed = observed_seen, predicted = as.numeric(fit_report$log_density_hat)) %>% 
  mutate(residuals = predicted - observed)


seeing_diagnostics <- data_frame(observed = observed_seeing, predicted = as.numeric(fit_report$prob_seeing)) 



```


```{r obs-v-pred, fig.cap="High level diagnostics for observed compontent of Delta-GLM, observed vs predicted log densities (A), predicted log density vs residuals (B), and a normal qq-plot of the residuals (C)"}

obs_v_pred <- seen_diagnostics %>% 
  ggplot(aes(observed, predicted)) + 
  geom_point(alpha = 0.5) + 
  geom_abline(aes(intercept = 0, slope = 1), linetype = 2, color = "red") + 
  labs(caption = glue::glue("R^2 is {round(yardstick::rsq(data = seen_diagnostics, truth = observed, estimate = predicted),2)}"), title= "A") + 
  theme(plot.margin = unit(rep(.1,4), units = "lines"))

fit_v_resid <- seen_diagnostics %>% 
  ggplot(aes(predicted, residuals)) + 
  geom_point() + 
  geom_hline(aes(yintercept = 0), linetype = 2, color = "red") + 
  labs(title = "B") +
    theme(plot.margin = unit(rep(.1,4), units = "lines"))

qq_plot <- ggplot(seen_diagnostics, aes(sample = residuals)) +
  stat_qq() +
  stat_qq_line() + 
  labs(title = "C") + 
    theme(plot.margin = unit(rep(.1,4), units = "lines"))


obs_v_pred/(fit_v_resid + qq_plot)


```



```{r, fig.cap = "Binned mean predicted probability of detection vs observed proportion of positive detections"}
seeing_diagnostics %>% 
  ungroup() %>% 
  mutate(binned_prob = ntile(predicted, 20)) %>% 
  arrange(binned_prob) %>% 
  group_by(binned_prob) %>% 
  summarise(mean_prob_seen = mean(predicted),
            percent_observed = mean(observed))  %>% 
  ggplot() +
  geom_point(aes(mean_prob_seen, percent_observed)) + 
  geom_abline(aes(intercept = 0, slope = 1), color = "red", linetype = 2) + 
  labs(x = "Binned Predicted Probability of Detection", y = "Proportion of Positive Observations")
  
```


### Correlations

```{r cor-plot, fig.cap = "Pre-MPA correlation of centered and scaled targeted and non-targeted fish abundance indicies"}
life_history <- fitted_data %>%
  select(classcode, targeted) %>%
  unique() %>%
  mutate(numeric_classcode = as.numeric(as.factor(classcode)))


numeric_species_key <-
  data_frame(classcode = unique(fitted_data$classcode)) %>%
  arrange(classcode) %>%
  mutate(numeric_classcode = 1:nrow(.))

raw <- fitted_data %>%
  group_by(year, classcode, targeted) %>%
  summarise(md = mean(exp(log_density))) %>%
  group_by(classcode) %>%
  mutate(smd = (md - mean(md))/(sd(md))) %>%
  ungroup() %>%
  left_join(numeric_species_key, by = "classcode")


ahnold_estimates <- base_run$tmb_fit[[1]]$ahnold_estimates

zissou_report <- base_run$tmb_fit[[1]]$ahnold_report

years <- fitted_data$year %>% unique
  
abundance_trends <- data_frame(abundance_hat = zissou_report$abundance_hat,
                               classcode = rep(1:n_distinct(fitted_data$classcode), each = length(years))) %>%
  mutate(log_abundance_hat = log(abundance_hat)) %>%
  group_by(classcode) %>%
  mutate(year = 1999 + 1:length(abundance_hat)) %>%
  mutate(scaled_abundance_hat = (abundance_hat - mean(abundance_hat)) / sd(abundance_hat)) %>%
  ungroup() %>%
  rename(numeric_classcode = classcode) %>%
  left_join(life_history, by = "numeric_classcode")

pre_treat_corr <- abundance_trends %>% 
  filter(year <= 2003) %>% 
  select(year,targeted, scaled_abundance_hat) %>% 
group_by(year, targeted) %>%   
  mutate(id = 1:length(scaled_abundance_hat)) %>% 
  spread(targeted, scaled_abundance_hat) %>% 
  ungroup() %>% 
  na.omit()

pre_cor <- round(cor(x = pre_treat_corr$`1`, y = pre_treat_corr$`0`),2)

pre_cor_plot <- pre_treat_corr %>% 
  ggplot(aes(`0`,`1`)) + 
  geom_point() + 
  geom_abline(aes(intercept = 0, slope = 1), linetype = 2, color = "red") + 
  labs(x = "Non-Targeted", y = "Targeted", caption = glue::glue("Pearson correlation coefficient = {pre_cor}"))
pre_cor_plot

```



```{r}
base_run$non_nested_variables

```



## Data Summaries
data coverage

```{r, fig.cap = "Spatio-temporal sampling intensity. Points are sampling sites, size and opacity indicate number of years that site has been sampled. Color indicates whether the site is in an eventual MPA site"}

site_summary <- pisco_data %>% 
  left_join(site_data, by = c("site","side")) %>% 
    filter(region %in% c("ANA","SCI","SRI","SMI")) %>% 
  group_by(site) %>% 
  summarise(nobs = length(log_density),
            nyears = n_distinct(year),
            pre_mpa = min(year) < 2003,
            post_mpa = max(year) > 2003,
            lat = mean(lat_wgs84, na.rm = T),
            long = mean(lon_wgs84, na.rm = T),
            mpa = unique(eventual_mpa))

ggmap::qmplot(long, lat, size = nyears, alpha = nyears, color = mpa, data = site_summary) + 
  theme_minimal()

```


Evidence of regional populations

```{r}

fitted_data %>% 
  group_by(region, year, classcode) %>% 
  summarise(mean_density = mean(exp(log_density))) %>% 
  mutate(log_mean_density = log(mean_density)) %>% 
  ungroup() %>% 
  ggplot(aes(year, mean_density, color = region)) + 
  geom_line() + 
  facet_wrap(~classcode, scales = "free_y") + 
  theme_minimal()


```


Standardized vs raw means


```{r raw-v-stand-plot, fig.cap = "Raw (points) and standardized (lines) indices of abundance for each of the species included in the analysis"}


ahnold_estimates %>% 
  filter(str_detect(variable, "targeted_did_betas")) %>% 
  group_by(variable) %>% 
  mutate(year = years) %>% 
  ggplot() + 
  geom_line(aes(year, estimate, color = variable)) +
  geom_pointrange(aes(year, estimate, ymin = lower, ymax = upper, color = variable))
  
abundance_trends <- data_frame(abundance_hat = zissou_report$abundance_hat,
                               classcode = rep(1:n_distinct(fitted_data$classcode), each = length(years))) %>%
  mutate(log_abundance_hat = log(abundance_hat)) %>%
  group_by(classcode) %>%
  mutate(year = 1999 + 1:length(abundance_hat)) %>%
  mutate(scaled_abundance_hat = (abundance_hat - mean(abundance_hat)) / sd(abundance_hat)) %>%
  ungroup() %>%
  rename(numeric_classcode = classcode) %>%
  left_join(life_history, by = "numeric_classcode" )

abundance_trends %>%
  ggplot(aes(year, log(abundance_hat), color = factor(classcode))) +
  geom_line(show.legend = F) +
  geom_vline(aes(xintercept = 2003), linetype = 2, color = "red") +
  facet_wrap(~classcode) +
  theme_minimal()



abundance_trends %>%
  ggplot(aes(year, scaled_abundance_hat, color = factor(classcode))) +
  geom_line(show.legend = F) +
  geom_vline(aes(xintercept = 2003), linetype = 2, color = "red") +
  geom_point(data = raw,aes(year, smd, color = factor(classcode)), show.legend = F)+
  facet_wrap(~classcode) +
  theme_minimal()

```




```{r numeric-cor, fig.cap="Pearson correlation coefficients of continuos data included in the regression model"}

base_run$data[[1]] %>% 
  select_if(is.numeric) %>% 
  select(-log_density,-targeted) %>% 
  na.omit() %>% 
  corrr::correlate() %>% 
  gather("colname","correlation",-rowname) %>% 
  ggplot(aes(rowname, colname,fill = correlation)) + 
  geom_tile() + 
  geom_text(aes(rowname, colname, label = round(correlation,2))) + 
  scale_fill_gradient2(low = "tomato", mid = "white", high = "steelblue", midpoint = 0, limits = c(-1,1)) + 
  theme(axis.text.x = element_text(angle = 45, vjust = .5),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) 
  
  

```



DiD fit to various forms of the raw means etc. 

Repeat basic analysis. 

```{r, eval = F}

raw <- fitted_data %>%
  group_by(year, classcode, targeted) %>%
  summarise(md = mean(exp(log_density)),
            mt = mean(temp_deviation)) %>%
  group_by(classcode) %>%
  mutate(smd = (md - mean(md))/(sd(md))) %>%
  ungroup() %>%
  left_join(numeric_species_key, by = "classcode")

raw_region <- fitted_data %>%
  group_by(year, region,classcode, targeted) %>%
  summarise(md = mean(exp(log_density)),
            mt = mean(temp_deviation)) %>%
  group_by(classcode) %>%
  mutate(smd = (md - mean(md))/(sd(md))) %>%
  ungroup() %>%
  left_join(numeric_species_key, by = "classcode")


raw_mpa_only <- fitted_data %>%
  filter(eventual_mpa == T) %>% 
  group_by(year, classcode, targeted) %>%
  summarise(md = mean(exp(log_density)),
            mt = mean(temp_deviation)) %>%
  group_by(classcode) %>%
  mutate(smd = (md - mean(md))/(sd(md))) %>%
  ungroup() %>%
  left_join(numeric_species_key, by = "classcode")

raw_nompa_only <- fitted_data %>%
  filter(eventual_mpa == F) %>% 
  group_by(year, classcode, targeted) %>%
  summarise(md = mean(exp(log_density)),
            mt = mean(temp_deviation)) %>%
  group_by(classcode) %>%
  mutate(smd = (md - mean(md))/(sd(md))) %>%
  ungroup() %>%
  left_join(numeric_species_key, by = "classcode")

basic_model <- rstanarm::stan_glm(log(md + 1e-3) ~ factor(year) + targeted + factor(year):targeted, data = raw)

basic_plus_model <- rstanarm::stan_glm(log(md + 1e-3) ~ factor(year) + targeted + factor(year):targeted + mt, data = raw)


basic_plus_mpa_model <- rstanarm::stan_glm(log(md + 1e-3) ~ factor(year) + targeted + factor(year):targeted + mt, data = raw_mpa_only)

basic_plus_nompa_model <- rstanarm::stan_glm(log(md + 1e-3) ~ factor(year) + targeted + factor(year):targeted + mt, data = raw_nompa_only)


basic_plus_region_model <- rstanarm::stan_glm(log(md + 1e-3) ~ factor(year) + targeted + factor(year):targeted + mt, data = raw_region)



basic_plot <- basic_model %>% 
  broom::tidy() %>% 
  filter(str_detect(term, ":targeted")) %>% 
  mutate(year = str_replace_all(term,"\\D","") %>% as.numeric()) %>% 
  ggplot() + 
  geom_hline(aes(yintercept = 0),linetype = 2, color = "black") +
  geom_vline(aes(xintercept = 2003),linetype = 2, color = "red") +
  geom_pointrange(aes(year, estimate, ymin = estimate - 1.96*std.error,
                      ymax = estimate + 1.96*std.error))

basic_plus_plot <- basic_plus_model %>% 
  broom::tidy() %>% 
  filter(str_detect(term, ":targeted")) %>% 
  mutate(year = str_replace_all(term,"\\D","") %>% as.numeric()) %>% 
  ggplot() + 
  geom_hline(aes(yintercept = 0),linetype = 2, color = "black") +
  geom_vline(aes(xintercept = 2003),linetype = 2, color = "red") +
  geom_pointrange(aes(year, estimate, ymin = estimate - 1.96*std.error,
                      ymax = estimate + 1.96*std.error))

basic_plus_mpa_plot <- basic_plus_mpa_model %>% 
  broom::tidy() %>% 
  filter(str_detect(term, ":targeted")) %>% 
  mutate(year = str_replace_all(term,"\\D","") %>% as.numeric()) %>% 
  ggplot() + 
  geom_hline(aes(yintercept = 0),linetype = 2, color = "black") +
  geom_vline(aes(xintercept = 2003),linetype = 2, color = "red") +
  geom_pointrange(aes(year, estimate, ymin = estimate - 1.96*std.error,
                      ymax = estimate + 1.96*std.error))


basic_plus_region_plot <- basic_plus_region_model %>% 
  broom::tidy() %>% 
  filter(str_detect(term, ":targeted")) %>% 
  mutate(year = str_replace_all(term,"\\D","") %>% as.numeric()) %>% 
  ggplot() + 
  geom_hline(aes(yintercept = 0),linetype = 2, color = "black") +
  geom_vline(aes(xintercept = 2003),linetype = 2, color = "red") +
  geom_pointrange(aes(year, estimate, ymin = estimate - 1.96*std.error,
                      ymax = estimate + 1.96*std.error))


 <- raw %>% 
  ungroup() %>% 
  ggplot(aes(year, md, color = targeted == 1, fill = targeted == 1)) + 
  geom_point(data = raw %>% group_by(year, targeted) %>% summarise(lmmd = (mean(md))), aes(year, lmmd, color = targeted == 1)) +
  geom_vline(aes(xintercept = 2003), linetype = 2, color = "red") +
  geom_smooth()


dropgrid <- expand.grid(targeted = unique(fitted_data$classcode[fitted_data$targeted == 1]),
            nontargeted = unique(fitted_data$classcode[fitted_data$targeted == 0]), stringsAsFactors = F) %>%
  as_data_frame()
  
  drops <- map2(dropgrid$targeted,dropgrid$nontargeted, ~c(.x,.y))

raw_mpa_story <- raw_mpa_only %>% 
  ungroup() %>% 
  ggplot(aes(year, md, color = targeted == 1, fill = targeted == 1)) + 
  geom_point(data = raw %>% group_by(year, targeted) %>% summarise(lmmd = (mean(md))), aes(year, lmmd, color = targeted == 1)) +
  geom_vline(aes(xintercept = 2003), linetype = 2, color = "red") +
  geom_smooth()

raw_nompa_story <- raw_nompa_only %>% 
  ungroup() %>% 
  ggplot(aes(year, md, color = targeted == 1, fill = targeted == 1)) + 
  geom_point(data = raw %>% group_by(year, targeted) %>% summarise(lmmd = (mean(md))), aes(year, lmmd, color = targeted == 1)) +
  geom_vline(aes(xintercept = 2003), linetype = 2, color = "red") +
  geom_smooth()


```


- Show how you could in theory use the model to estimate the MPA effect
- Show how things break down under the real world, i.e. what you'd need to collect to detect the thing
- Illustrate with real world example of the fitting challenge
- So what would you need to overcome this?


**explain that experiment is the same as dif in dif**
** raw data trends first**
**couch parallel trends in single species modeling framework**
