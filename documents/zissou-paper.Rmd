---
title: "Predicting and Detecting the Regional-Scale Conservation Impacts of Marine Protected Areas"
output: 
  bookdown::pdf_document2:
  bookdown::html_document2:
bibliography: dissertation.bib
linkcolor: blue
biblio-style: apalike
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r options}
library(sf)
library(viridis)
library(hrbrthemes)
library(scales)
library(patchwork)
library(rpart)
library(extrafont)
library(caret)
library(ggsci)
library(tidyverse)
extrafont::loadfonts()

functions <- list.files(here::here("functions"))

walk(functions, ~ here::here("functions", .x) %>% source()) # load local functions

sim_years <- 50

burn_years <- 20

num_patches <- 25




  samps <- 20000
 
  run_name <- "v3.0"

run_dir <- here::here("results", run_name)

experiment_dir <- here::here("results",run_name, "experiments")

load(file = here::here("results",run_name, "rawish_zissou_data.Rdata"))

load(file = here::here("results",run_name, "model_runs_good.Rdata"))

load(file = here::here("results",run_name,"processed_grid.Rdata"))

  zissou_theme <- theme_ipsum(base_size = 10, axis_title_size = 12, strip_text_size = 12)

  theme_set(zissou_theme)
  

models_worked <- model_runs$tmb_fit %>% map("error") %>% map_lgl(is_null)

model_runs <- model_runs %>%
  slice(models_worked) %>%
  mutate(tmb_fit = map(tmb_fit,"result")) %>%
  mutate(processed_fits = map(tmb_fit, process_fits)) %>%
  mutate(did_plot = map(processed_fits, "did_plot"))

base_run <- model_runs %>% 
  slice(1) #%>% 
  # filter(var_names == "pisco_a", mpa_only == FALSE, center_scale == TRUE)
  
fitted_data <- base_run$data[[1]]

zissou_fit <- base_run$tmb_fit[[1]]

report <- base_run$tmb_fit[[1]]

site_data <- read_csv(here::here("data",'Final_Site_Table_UCSB.csv')) %>%
  magrittr::set_colnames(., tolower(colnames(.))) %>%
  select(
    site,
    side,
    mpagroup,
    mpa_status,
    reserve,
    region,
    year_mpa,
    mpaareanm2,
    lat_wgs84,
    lon_wgs84
  ) %>%
  rename(lat_wgs84 = lon_wgs84,
         lon_wgs84 = lat_wgs84) %>%
  unique() %>%
  mutate(eventual_mpa = (year_mpa > 0))


 seen_non_nested_betas <- zissou_fit$zissou_estimates %>%
   filter(variable == "seen_non_nested_betas") %>%
   rename(group = variable) %>%
   mutate(variable  = zissou_fit$seen_cdata$x_non_nested %>% colnames())

 seeing_non_nested_betas <- zissou_fit$zissou_estimates %>%
   filter(variable == "seeing_non_nested_betas") %>%
   rename(group = variable) %>%
   mutate(variable  = zissou_fit$seen_cdata$x_non_nested %>% colnames())

 seen_year_species_betas <- zissou_fit$zissou_estimates %>%
   filter(variable == "seen_year_species_betas") %>%
   rename(group = variable) %>%
   mutate(variable = zissou_fit$seen_cdata$x_year_species %>% colnames())

 seeing_year_species_betas <- zissou_fit$zissou_estimates %>%
   filter(variable == "seeing_year_species_betas") %>%
   rename(group = variable) %>%
   mutate(variable = zissou_fit$seen_cdata$x_year_species %>% colnames())

 seen_region_cluster_betas <- zissou_fit$zissou_estimates %>%
   filter(variable == "seen_region_cluster_betas") %>%
   rename(group = variable) %>%
   mutate(variable = zissou_fit$seen_cdata$x_region_cluster %>% colnames())

 seeing_region_cluster_betas <- zissou_fit$zissou_estimates %>%
   filter(variable == "seeing_region_cluster_betas") %>%
   rename(group = variable) %>%
   mutate(variable = zissou_fit$seen_cdata$x_region_cluster %>% colnames())

 did_betas <- zissou_fit$zissou_estimates %>%
   filter(variable == "mpa_effect") %>%
   mutate(group = variable) %>%
   mutate(year = fitted_data$year %>% unique())


 betas <- bind_rows(
   seen_non_nested_betas,
   seeing_non_nested_betas,
   seen_year_species_betas,
   seeing_year_species_betas,
   seen_region_cluster_betas,
   seeing_region_cluster_betas,
   did_betas %>% select(-year)
 ) %>%
   as_data_frame()

 non_nested_beta_plot <- betas %>%
   filter(str_detect(group, "non_nested")) %>%
   ggplot() +
   geom_hline(aes(yintercept = 0), linetype = 2, color = "red") +
   geom_pointrange(aes(x = variable,
                       y = estimate,
                       ymin = lower,
                       ymax = upper)) +
   facet_wrap(~group) +
   coord_flip() +
   theme(axis.text.y = element_text(size = 10))


 year_species_effects_plots <- betas %>%
   filter(str_detect(group, "year_species_betas")) %>%
   mutate(year = str_replace_all(variable,"\\D","") %>% as.numeric()) %>%
   mutate(classcode = str_split(variable,'-', simplify = T)[,2]) %>%
   ggplot() +
   geom_hline(aes(yintercept = 0), linetype = 2, color = "red") +
   geom_ribbon(aes(x = year, ymin = lower, ymax = upper, fill = classcode), alpha = 0.25) +
   geom_line(aes(x = year, y = estimate, color = classcode)) +
   facet_wrap(~group)

  region_cluster_plots <- betas %>%
   filter(str_detect(group, "region_cluster_betas")) %>%
   mutate(cluster = str_replace_all(variable,"\\D","")) %>%
   mutate(region = str_split(variable,'-', simplify = T)[,3]) %>%
   ggplot() +
    geom_hline(aes(yintercept = 0), linetype = 2, color = "red") +
    geom_pointrange(aes(x = region,
                        y = estimate,
                        ymin = lower,
                        ymax = upper, color = cluster)) +
    facet_wrap(~group)



 did_plot <- did_betas %>%
   ggplot() +
   geom_vline(aes(xintercept = 2003), color = 'red', linetype = 2, size = 2) +
 geom_hline(aes(yintercept = 0)) +
   geom_pointrange(aes(
     year,
     y = estimate,
     ymin = lower,
     ymax = upper
   ),
   size = 1.5) +
   labs(x = "Year", y = "Targeted Trend Divergence")



```

# Key questions

- How deep down the simulation testing rabbit hole of the regression model do we want to go? Just talking about the strength and weaknesses of the identification strategy, or actually demonstrate with simulation testing? I have the simulation testing of the regression more or less ready to go, but definitely needs some refinement. 

- What exactly do we want to say about the MPA coefficients? I certainly don't think we can hang our hat on them as 100% causal, but I would argue they give more evidence than simpler analyses. See discussion for my take on this so far. 

- "Regional" term? I'm not a big fan, since "region" is such a fuzzy concept. Network-wide? Though that doesn't really work if you just have one  big MPA? Population wide? Most accurate to the way that we model things? Large-scale?

- Model selection. I'm running a whole pile of alternative model configurations at the moment, will report back, but broadly the testing that I've done produces just about the same divergence coefficients, so plan for the paper is to show bare bones model (not really any other controls besides the year effects) on up to the max, and show that the overall results are stable, and adding in more controls just tightens up the standard errors. But can do a more formal approach if desired. 


# Abstract


# Introduction

Insert punchy statement about MPAs, conservation, ecosystems, and fisheries that isn't the same as every other one. 

## What do We Expect from MPAs?

Marine Protected Areas (MPAs, which we will define here as spatial regions in the ocean in which fishing for species of interested is prohibited, acknowledging that other regulatory definitions of MPAs exist) have a long history in the management of marine resources. Traditional cultures in Oceania utilized (often temporary) MPAs as a sort of "fish bank" for times of need [@Johannes1978]. In more recent times, MPAs were first (XX) put in place primarily as conservation areas, analogs to terrestrial parks deigned to protect iconic landscapes such as Yellowstone or Kruger National Parks. However, over time our goals and expectations for MPAs have evolved; we now frequently consider the use of MPAs to both protect marine ecosystems within their boundaries and bolster fish populations and fishing opportunities in their surrounding waters.  

As our desired outcomes from MPAs have increased, so too has the complexity of understanding what the magnitude of these "spillover" benefits may be. We have clear and compelling evidence that well enforced MPAs provide conservation benefits within their border [@Lester2009;@Halpern2003; @Edgar2014]. However, the evidence for total spillover benefits is far less complete. There is some evidence for spillover of adults and larvae to areas outside of MPAs, but the evidence is far from clear and generally lack controls [citations]. This lack of clarity regarding what we call the regional-level effects of MPAs (i.e. the net effects of MPAs on fish populations both inside and outside their borders) should not be surprising; the degree and nature of spillover benefits will clearly depend on a host of enabling conditions. A massive MPA covering nearly all of a severely overfished region will almost certainly have huge conservation benefits throughout the region. An MPA of any size placed in a barely fished region will have little added benefit. 

As stakeholders around the world increasingly seek to use MPAs in the marine resource management portfolios, It is critically important that we develop a better understanding of the magnitude and drivers of regional-scale MPA effects. To address this gap, this paper examines two critical questions: 1) What to we expect the regional-scale conservation effects of MPAs to be and 2) When (and how) can we expect to detect these effects? We address these questions using a simulation analysis framework, paired with an empirical assessment of the evidence for region-level effects of MPAs resulting from a network of closures put in place in the Channel Islands, California, in 2003. 

## What Does Theory Tell Us?

Before we start, we should define "regional-scale conservation MPA effects" for the purposes of this paper. We define regional-scale conservation MPA effects as the change in total biomass of fish (summing inside and outside of MPAs) relative to the total biomass fish that would have occurred without the MPA In clearer words, how many more or less fish are there throughout the study region as a result of one or more MPAs? Defining "regional" is not a clear-cut exercise. Regional could be defined as a bio-geographic area (e.g. the Channel Islands), or as the range of a population (in line the a fisheries definition of a "stock"). XX what's our solution to thisXX. For brevity's sake, for the remainder of this paper we will refer to the "regional-scale conservation MPA effects" as regional effects. 

With that definition in mind, what does basic theory suggest should be the magnitude of these regional effects? On one hand, if we imagine a region that has driven its fish populations to near extinction, which then places 100% of its waters inside a no-take MPA, we would expect the regional-scale conservation effects to be massive, and in fact to approach infinity (in terms of percentage increase) the closer the "pre MPA" populations approach zero (assuming that the populations are not so depleted as to prevent recovery). On the other hand, If we place an MPA in place for a lightly fished sedentary species, and in doing so displace a large amount of fishing effort to the waters outside the MPA, it is actually possible to create a net conservation loss. So, this extremely helpful exercise tells us that regardless of almost any other factor, the range of possible regional effects (on a percentage scale) spans something on the order of some negative number to positive infinity. 

However, within these highly informative bounds, numerous other factors can act to affect the regional effects of MPAs. These include, but are certainly not limited to, the scale of adult and larval dispersal relative to the size of the MPAs [@Gaines2003; @Botsford2008], the strength and timing of density dependence in the population (e.g. pre or post settlement), how overfished the population was pre-MPA, and how fishing activity responds to the implementation of the MPAs [@Hilborn2004; @Hilborn1992; @Walters2004; @Hastings2003;@Gerber2003; @Gerber2005; @Hilborn2004a; @Gaines2010]. In addition, even for the same total area of MPAs, the location and spacing of the MPAs can have a profound influence on their cumulative impact through habitat and network effects [@Gaines2010; @Costello2010]. Broadly, a wide range of theory and modeling exercises indicate that the expected effects of MPAs can vary widely and are extremely context dependent [@Fulton2015]. 

At the most "conservation friendly" side of things, we could imagine a group of heavily fished species that are largely sedentary as adults, broadcast larvae throughout the region, have post-settlement density dependence, and have a fishing fleet that exits the fishery in proportion to the area protected inside MPAs. Under these circumstances, the MPAs can be expected to provide a substantial influx of new recruits to the overfished areas outside of the reserve, even as the reserve fills in with adults. At the other end, consider a complex of lightly fished species with relative high adult mobility, pre-settlement density dependence (e.g. at the spawning level), and a fishing fleet that concentrates into the remaining fished areas. Under these circumstances, it will be much more challenging for the MPA to provide substantial conservation benefits. Theory then helps us think about the likely regional effects of a given MPA, but outside of these simple cases the cumulative effect of interacting drivers means that the expected regional effects are not analytically solvable or obviously predictable. 

## What Empirical Evidence Do We Have?

It is beyond the scope of this paper to conduct an exhaustive review of empirical evidence for regional-scale conservation effects of MPAs. However, we present here several pieces of empirical evidence of regional effects to demonstrate the challenges of detection, and variety of detected outcomes, in real-world scenarios. We focus here on evidence of the regional effects of MPAs, see @Lester2009 for a thorough review of within-MPA effects. Many of the studies that explore the effects of MPA outside of their borders focus on studying gradients of abundance, commonly measured through catch-per-unit-effort (CPUE) along distances from MPA borders. Presence of negative gradients (decreasing CPUE with distance from MPA border) is taken as evidence of "spillover", or the export of (generally) biomass from MPAs to their surrounding fished areas

@Halpern2009 conducted a rigorous meta-analysis of empirical evidence for spillover from MPAs. They find that frequent evidence for spillover from MPAs, but at relatively small spatial scales (on average up to 800m from reserve boundaries). @Gell2003 surveyed empirical evidence for adult and larval spillover from MPAs. They documented numerous examples of studies showing decreases in CPUE of adult biomass with distance from MPA borders, commonly attributed to buildup of density inside MPAs and subsequent export of fish biomass, though they also note that evidence for larval spillover is far less clear.

@Russ1996 documents changes in densities or large predatory fish inside and outside of a small marine reserve on Apo Island, Philippines (0.45km long at the time). They report a positive correlation between years of MPA existence and fish densities, but note that up to 8 years of protections were required to detect a significant gradient in fish densities radiating from the reserve borders. @Russ2003a presents a similar study focused on the surgeonfish *Naso vlamingii*, in which they find dramatic density increases within the reserve, as well as a strong correlational relationship showing catch-per-unit effort of *Naso vlamingii* decreasing with distance from the reserve boundary. 
Turning to Europe, several studies have explored MPA spillover in that region. In a similar manner to @Russ1996, @Harmelin-Vivien2008 assessed gradients in fish density at increasing distances from cores of MPAs as evidence of spillover in the Mediterranean. They report evidence of decreases in biomass densities with distance from MPA borders, though these effects largely dissipated within 100s of meters of MPA boundaries. @Vandeperre2011 conducted a meta-analysis of spillover effects (again measured as CPUE along distance-from-MPA gradients over time) around MPA in Southern Europe. They also document some evidence of declines in CPUE with distance from MPA border, as well as a 2-4% increase in CPUE per year in the fished area following MPA implementation. @Guidetti2007a finds similar results in the region. 

@McClanahan2000 measured spillover effects around the Mombasa Marine Park in Kenya. They also provide evidence of negative CPUE gradients with distance from MPA border, but note that these effects are highly affected by habitat, environmental, and management variables. They document the largest effects for moderately mobile species (e.g. surgeonfish)

<!-- @Fletcher2014 provides an assessment of the fishery impacts of the Great Barrier Reef. They measured fishing rates and total landings before and after the 28% expansion no-take marine reserves within the greater GBR reserve, relative to selected control sites outside the reserve. Modeling exercise had predicted a 10% increase in catch inside the GBR as a function of the new closures; in fact catches decreased ~35% relative to the reference sites over that time. So, this provides some evidence that a network of reserves did not achieve the model-predicted increases in catch (full disclosure, I haven't had time to dig into their methods much though). -->

<!-- @Hughes2016 provides counterevidence to this -->

Several studies have explored the spillover effects of MPAs along the California coast. @Starr2015 and @Caselle2015 both document rapid but variable changes in fish densities related to marine reserve networks in the Channel Islands and along the central California coast. @Starr2015 found evidence that densities inside MPAs had increased on average, but effects were variable, and found little substantial changes in densities in control sites outside the reserves. @Caselle2015 found similar results, documenting faster increases of densities of fished species inside reserves than outside, but little change in densities in reference sites. Both of these studies then suggest that spillover benefits may be slow (~10 years) to accrue. @Kay2012 reports strong evidence of spillover of adult lobster from MPAs in the Channel Islands. @Thompson2017 reports increases in abundance of the larvae of fished rockfish species, relative to comparable trends of larval abundance for unfished species, following implementation of rockfish-specific MPAs along the California coast. 

<!-- Galapagos @Buglas2018 -->

<!-- Molloy et al. - 2009 - Effects of marine reserve age on fish populations, @Molloy2009 -->

<!-- @Edgar2014 -->

<!-- @Halpern2009 -->

Taken together then, while a large body of literature has examined the theory for regional-scale MPA effects, very little empirical evidence directly tackles the questions "do MPA cause a net change in regional fish biomass, and if so how much"? Nearly all of the empirical evidence of which we are aware measures regional-scale effects by quantifying measures such as CPUE along distance gradients from MPA borders. These studies by and large conclude that these spillover effects are detectable, but a) can be confounded by environmental and management variables and b) often dissipate at distances greater than 1km from a reserve border. While these studies are extremely important contributions to our understanding of regional MPA effects, they do not directly address the question of total regional effects of MPAs. 

## How Can We Detect Regional MPA Effects?

Given that we know that the regional level conservation effects of MPAs can vary dramatically, how can we go about detecting these effects in real systems? Under our definition, the conservation effect reflects the change in abundance resulting from the MPA relative to what would have happened without the MPA. This is a nice definition, but unfortunately is effectively impossible for us to truly observe in nature. For the case of assessing the conservation effects MPAs inside their borders, the gold-standard tends to be before-after-control-impact (BACI) studies (analogous to what is commonly referred to as a difference-in-difference analysis in econometrics). In BACI studies, ideally a set of appropriately matched control and "impact" sites are selected, where the "impact" refers to the eventual implementation of MPAs. Measures of species abundance in the control and impact sites are monitored for some period of time pre and post MPA, and the effect of the MPA on the impact sites (i.e. inside the MPAs) is the difference in the trends in the control and impact sites. So, if abundances at both control and impact sites are trending up, but the impact sites are trending up faster than the control sites, this is evidence that the MPA is "working" inside its borders. 

While well designed BACI studies are clearly difficult to successfully implement, and subject to their own set of caveats and assumptions, properly implemented are an effective strategy for robustly estimating within-border MPA conservation effects. However, at the regional scale the task becomes much more complicated. Take for example the Channel Islands region off the coast of California (Fig.\@ref(fig:ci-map)). The Channel Islands is a ecologically diverse region that supports a range of fisheries. A network of MPAs was implemented in the Channel Islands in 2003, with the express goal of both providing conservation and fishery benefits throughout the region (citation). 15 years after their implementation, how can we tell if they successfully caused an increase in fish abundance throughout the Islands? Following the BACI example above, ideally we would like a carbon copy of the Channel Islands that could be kept MPA-free and monitored pre and post MPA implementation in the "treated" Channel Islands. This is of course impossible; we could perhaps envision utilizing nearby regions as controls, e.g. the mainland coastal waters of the Santa Barbara Channel, but this region is quite different than the ecosystems in the Channel Islands (XX improve this section). 

Broadly then, as we seek to understand the regional scale effects of MPAs, and as the size of those regions increases, the harder it becomes to find a practical control for the treated region. As a result, it becomes challenging to determine what post-MPA changes throughout the region are attributable to the MPAs and which to other factors. If abundance continue to trend downwards post-MPA, without a control we cannot truly know whether they might have trended down faster without the MPAs. Or, if abundances are trending up, we cannot reliably say that the upward trend is not due to some environmental driver. Regression analysis can help (e.g. statistically controlling for El Niño), but depends on "selection on observables", meaning that in order to interpret the MPA coefficients as causal, we have to assume that we have included all the correct covariates that might also be correlated with the outcome of interest (in this case densities). Failure to account for some important variable in our regression can bias results. 

<!-- In econometrics, which is generally concerned with identifying the causal effect of a specific policy or intervention, etc... XX talk about identification strategies... -->

We have then two broad options for estimating the regional effect of MPAs in a place like the Channel Islands: We can depend on selection on observables through regression analysis, or we can find an identification strategy. Given the shortcomings of the first approach, we propose an identification strategy building off of @Caselle2015, in which we consider relatively unfished species such as Garibaldi (*Hypsypops rubicundus*) to be "controls" for more heavily fished species such as Blue Rockfish (*Sebastes mystinus*). Under this strategy, our assumption is that unfished species are more or less unaffected by the implementation of MPAs (unlike the fished species), but that both species are potentially affected by regional environmental trends. In this way, the unfished species can serve as our control for environmentally driven shifts in abundance, allowing us to attempt to better isolate changes in abundance driven by MPAs from changes caused by environmental conditions. 

<!-- With that identification strategy in place, we are still faced with a challenge of estimating the effect in real systems. We know already that the magnitude of MPA effects can vary dramatically, and we have some evidence that the net effect may be relatively small. Marine systems also ofen experience high degrees of environmental variability, and are difficult places to monitor, leading to potentially high levels of both natural variability and observation error. This creates a problem then that we are trying to detect whay may be a relatively small effect in a very noisy system.  -->

## Project Summary

We are faced with three challenges then in understanding and estimating the likely regional scale conservation impacts of MPAs: 1) Understanding the likely magnitude of regional effects of MPAs, 2) developing an identification strategy to estimate the regional effect in real systems, and 3) exploring under what circumstances this identification strategy may be effective. This paper address each of these challenges through the following steps. 

We first utilize a spatially explicit, age structured bio-economic model to generate simulations of "true" regional-scale MPA conservation effects under a wide range of plausible conditions. We then consider, given the range of effect sizes observed in this simulation exercise, under what conditions our proposed identification strategy might be able to reliably detect this true effect (XX not doing this so much anymore). We close with an illustration of this process using data from the Channel Islands to estimate the effect of the network of MPAs put in place there in 2003. The results of this process will illustrate plausible ranges for the regional conservation effects of MPAs, and demonstrate the challenges of estimating these effects in real life. 


# Results and Discussion

## Simulated MPA Effects

```{r}
outcomes <- processed_grid %>%
  slice(1:samps) %>% 
  unnest() %>% 
  mutate(year = year - burn_years) %>% 
  mutate(years_protected = year - year_mpa + 1) %>% 
  mutate(mpa_effect = pmin(mpa_effect,2)) %>% 
  group_by(experiment) %>% 
  mutate(b0 = `no-mpa`[year == min(year)]) %>% 
  mutate(depletion = 1 - `no-mpa`/b0) %>% 
  ungroup() %>% 
  mutate(pop_effect = pmin(1,(`with-mpa` - `no-mpa`) / b0))

eqo <- outcomes %>% 
  filter(year == max(year))

```

We used our bio-economic model to model the regional effects of MPAs across 20,000 simulated fisheries spanning a wide range of plausible states of nature, including degrees of larval and adult movement, density dependence, fleet dynamics, life history, and pre-MPA exploitation levels (seem SI for details on the simulation process). For simplicity's sake at this point we focus on single species outcomes, though since we do not model species interactions fisheries could be aggregated together to provide multi-specie MPA effects. It is critical to note that we have no current way of assigning probabilities to any of these states of nature, though we have tried to constrain the parameter space to plausible states. Therefore, the results of our simulations suggest simply the number of simulated ways that a given outcome could happen; we do not have any knowledge though if in reality some of these simulated outcomes are individually much more or less likely than others. But, if we assume that the simulated parameter space is a reasonable representation of a range of plausible states of nature, these results provide an indication of the general magnitude of effects that we might expect. 

```{r}
short_term <- outcomes %>% 
  filter(years_protected <= 15, years_protected >= 0)


small_effect <- round( 100* median(short_term$mpa_effect[short_term$mpa_size <= 0.25 & short_term$depletion <= 0.5]))

min_small_effect <- round( 100* min(short_term$mpa_effect[short_term$mpa_size <= 0.25 & short_term$depletion <= 0.5]))

max_small_effect <- round( 100* max(short_term$mpa_effect[short_term$mpa_size <= 0.25 & short_term$depletion <= 0.5]))

medium_effect <- round(100*median(short_term$mpa_effect[short_term$depletion > 0.5 & short_term$depletion <= 0.75]))

big_effect <- round(100*median(short_term$mpa_effect[short_term$depletion > 0.5 & short_term$depletion > 0.75]))
```


Across this range of scenarios, we see that the median simulated equilibrium regional effect (percentage change in total biomass) was `r round(100*median(eqo$mpa_effect))`%, with a min of `r round(100*min(eqo$mpa_effect))`% and a max of over `r round(100*max(eqo$mpa_effect))`%. We also see that while large percentage increases in biomass can accrue relatively rapidly under some circumstances, increases of over 10% took approximately 10 years to achieve for 50% of the simulated fisheries (Fig.\@ref(fig:trend-effect)). It is also clear from the simulations that even constrained by reasonable states of nature, a vast array of regional conservation MPA effects are possible. The exact expected regional effect for a given fishery will depend on a complex set of interactions among fishery variables (XX regression tree analysis?). However, two of the most critical factors affecting the direction and magnitude of the regional effect are the degree of overfishing present before (and continuing after) MPA implementation, and the size of the MPA, and so we focus on the effects of these two variables on regional MPA effects 15 years after MPA implementation (to mimic the time since implementation of the Channel Islands MPAs at the time of this publication). Across our simulated fisheries, the median 15 year simulated regional effect was `r round(100*median(short_term$mpa_effect))`%. For cases where "small" MPAs (smaller than 25%) were implemented in relatively unexploited fisheries (depletion < 50%), the median regional effect was `r small_effect`%. For moderate depletion (50% to 75%), MPA sizes from 1% to 50% produced median MPA effects of `r medium_effect`%, while for depletion above 75% the median regional effect from was `r big_effect`% (Fig.\@ref(fig:f-and-s-plot)-A). The median regional effect increased with both MPA size and depletion, but it is important to note that the ranges around these median values are extremely wide (Fig.\@ref(fig:f-and-s-plot)-B).

```{r trend-effect, fig.cap = "Distribution of simulated regional MPA effects over time (A), and at equilibrium (B)"}

trend_plot <- outcomes %>%
  filter(years_protected >0) %>% 
  ungroup() %>% 
  ggplot(aes(
    years_protected,
    mpa_effect,
    group = years_protected
  )) +
  geom_boxplot() +
  geom_hline(aes(yintercept = 0), linetype = 2, color = "red") +
  scale_y_continuous(labels = scales::percent, name = "Regional Effect") + 
  labs(x = "Years of MPA Protection")

density_plot <- outcomes %>% 
  filter(years_protected > 0, year == max(year)) %>% 
  ggplot(aes(mpa_effect)) + 
  geom_vline(aes(xintercept = 0), linetype = 2, color = "red") +
  geom_density(fill = "steelblue", alpha = 0.75) + 
  theme(axis.text.x = element_blank(), axis.title.x = element_blank(),
        axis.text.y = element_blank(), axis.title.y = element_blank(),
            plot.margin = unit(c(.05, .05, .05, .05), "lines"))


mpa_plots  <- (trend_plot + labs(title = "A")) + (density_plot + coord_flip() + labs(title = "B")) + plot_layout(ncol = 2, widths = c(2, 1))
  
mpa_plots

```


```{r f-and-s-plot, fig.cap = "Median (A) and range (B) regional effect after 15 years of protection across a range of pre-MPA depletions and MPA sizes"}


a = lm(mpa_effect ~ adult_movement*larval_movement + depletion + mpa_size + factor(density_dependence_form) + density_movement_modifier , data = outcomes)

fit_tree = rpart(
  mpa_effect ~ adult_movement + larval_movement + depletion + mpa_size + factor(density_dependence_form) + density_movement_modifier + factor(density_dependence_form) + density_movement_modifier,
  data = outcomes %>% filter(year == max(year))
)


adult_movement_plot <- outcomes %>% 
  mutate(rounded_am = plyr::round_any(adult_movement,1)) %>% 
  ggplot(aes(rounded_am,mpa_effect , group = rounded_am)) + 
  geom_boxplot()


larval_movement_plot <- outcomes %>% 
  mutate(rounded_lm = plyr::round_any(larval_movement,1)) %>% 
  ggplot(aes(rounded_lm,mpa_effect , group = rounded_lm)) + 
  geom_boxplot()

depletion_plot <- outcomes %>% 
  filter(years_protected == 15) %>% 
  mutate(rounded_dep = plyr::round_any(depletion,.05)) %>% 
  ggplot(aes(rounded_dep, mpa_effect, group = rounded_dep)) + 
  geom_boxplot() + 
  scale_y_continuous(labels = percent, name = 'Regional Effect') + 
  scale_x_continuous(labels = percent, name = "Initial Depletion")

size_plot <- outcomes %>% 
    filter(years_protected == 15) %>% 
  mutate(rounded_size = plyr::round_any(mpa_size,.05)) %>% 
  ggplot(aes(rounded_size, mpa_effect, group = rounded_size)) + 
  geom_boxplot() + 
  scale_y_continuous(labels = percent, name = "Regional Effect") + 
  scale_x_continuous(labels = percent, name = "Range in MPA")

  depletion_and_size_plot <- outcomes %>% 
    filter(years_protected >= 0) %>%
    group_by(experiment) %>% 
    mutate(depletion = plyr::round_any(depletion[years_protected == 0], .05),
           mpa_size = plyr::round_any(mpa_size, .05)) %>% 
    filter(years_protected == 15) %>% 
    group_by(depletion, mpa_size) %>% 
    summarise(median_mpa_effect = median(mpa_effect)) %>% 
    ggplot(aes(depletion, mpa_size, fill = median_mpa_effect)) + 
    geom_raster(interpolate = T) + 
    # geom_contour(aes(z = median_mpa_effect)) +
    scale_fill_viridis(labels = percent,
                       guide = guide_colorbar(frame.colour = "black",
                                              frame.linewidth = 1,
                                              barheight = unit(15,"lines")), 
                       name = "Regional Effect") +
  labs(x = "Initial Depletion", y = "Range in MPA") + 
    scale_y_continuous(labels = percent) + 
    scale_x_continuous(labels = percent)
  
  combo_plot <- (depletion_and_size_plot + labs(title = "A")) + ((size_plot + labs(title = "B")) / depletion_plot) * theme(plot.margin = unit(c(.1,.1,.1,.1), units = "lines"),axis.text.x = element_text(size = 10),                                                                        axis.text.y = element_text(size = 12)) + plot_layout(widths = c(2,1))
  
  combo_plot
```

The percentage change in biomass with and without MPAs is most analogous to the effects that can (in theory) be estimated by our identification strategy (the percentage difference in the density of targeted species relative to the non-targeted species pre and post MPA). However, the percentage change in biomass is a somewhat misleading metric from the perspective of meaningful conservation outcomes. Take for example an extremely depleted scenario where without MPAs a fishery is left with only 2 kg of fish. Suppose then that an MPA brings us up to 6 kg of fish, and that the unfished biomass in this fishery is 1,000kg. While the MPA has produced a 200% increase in fish biomass, this increase is relatively inconsequential given the scale of the population (we have only recovered 0.4% of the unfished biomass). 

To reflect this, we can repeat the analyses in Fig.\@ref(fig:trend-plot)-\@ref(fig:f-and-s-plot), but now expressing the change in biomass with and without MPAs as a percentage of unfished biomass for that fishery. Through this metric, we see median equilibrium effect sizes of `r round(100*median(eqo$pop_effect))`% (Fig. \@ref(fig:pop-trend-effect)). Over the 15 year time horizon, our simulations find that MPAs less than 25% produced a median effect of near `r round(100*median(short_term$pop_effect))`% (Fig. \@ref(fig:pop-f-and-s-plot)-A), but again with a wide range around the simulated outcomes outcomes, from `r round(100*min(short_term$pop_effect))`% to 100% (Fig. \@ref(fig:pop-f-and-s-plot)-B). 

```{r pop-trend-effect, fig.cap = "Distribution of simulated regional MPA effects (expressed as percent of unfished biomass) over time (A), and at equilibrium (B)"}

pop_trend_plot <- outcomes %>%
  filter(years_protected >0) %>% 
  ungroup() %>% 
  ggplot(aes(
    years_protected,
    pmin(1,pop_effect),
    group = years_protected
  )) +
  geom_boxplot() +
  geom_hline(aes(yintercept = 0), linetype = 2, color = "red") +
  scale_y_continuous(labels = scales::percent, name = "Regional Effect") + 
  labs(x = "Years of MPA Protection")

pop_density_plot <- outcomes %>% 
  filter(years_protected > 0, year == max(year)) %>% 
  ggplot(aes(pmin(1,pop_effect))) + 
  geom_vline(aes(xintercept = 0), linetype = 2, color = "red") +
  geom_density(fill = "steelblue", alpha = 0.75) + 
  theme(axis.text.x = element_blank(), axis.title.x = element_blank(),
        axis.text.y = element_blank(), axis.title.y = element_blank(),
            plot.margin = unit(c(.05, .05, .05, .05), "lines"))


pop_mpa_plots  <- (pop_trend_plot + labs(title = "A")) + (pop_density_plot + coord_flip() + labs(title = "B")) + plot_layout(ncol = 2, widths = c(2, 1))
  
pop_mpa_plots

```

```{r pop-f-and-s-plot, fig.cap = "Median (A) and range (B) regional effect (expressed as percent of unfished biomass) after 15 years of protection across a range of pre-MPA depletions and MPA sizes"}


pop_depletion_plot <- outcomes %>% 
  filter(years_protected == 15) %>% 
  mutate(rounded_dep = plyr::round_any(depletion,.05)) %>% 
  ggplot(aes(rounded_dep, pop_effect, group = rounded_dep)) + 
  geom_boxplot() + 
  scale_y_continuous(labels = percent, name = 'Regional Effect') + 
  scale_x_continuous(labels = percent, name = "Initial Depletion")

pop_size_plot <- outcomes %>% 
    filter(years_protected == 15) %>% 
  mutate(rounded_size = plyr::round_any(mpa_size,.05)) %>% 
  ggplot(aes(rounded_size, pop_effect, group = rounded_size)) + 
  geom_boxplot() + 
  scale_y_continuous(labels = percent, name = "Regional Effect") + 
  scale_x_continuous(labels = percent, name = "Range in MPA")

  pop_depletion_and_size_plot <- outcomes %>% 
    filter(years_protected >= 0) %>%
    group_by(experiment) %>% 
    mutate(depletion = plyr::round_any(depletion[years_protected == 0], .05),
           mpa_size = plyr::round_any(mpa_size, .05)) %>% 
    filter(years_protected == 15) %>% 
    group_by(depletion, mpa_size) %>% 
    summarise(median_mpa_effect = median(pop_effect)) %>% 
    ggplot(aes(depletion, mpa_size, fill = median_mpa_effect)) + 
    geom_raster(interpolate = T) + 
    # geom_contour(aes(z = median_mpa_effect)) +
    scale_fill_viridis(labels = percent,
                       guide = guide_colorbar(frame.colour = "black",
                                              frame.linewidth = 1,
                                              barheight = unit(15,"lines")), 
                       name = "Regional Effect") +
  labs(x = "Initial Depletion", y = "Range in MPA") + 
    scale_y_continuous(labels = percent) + 
    scale_x_continuous(labels = percent)
  
  pop_combo_plot <- (pop_depletion_and_size_plot + labs(title = "A")) + ((pop_size_plot + labs(title = "B")) / pop_depletion_plot) * theme(plot.margin = unit(c(.01,.01,.01,.01), units = "lines"),axis.text.x = element_text(size = 10),                                                                        axis.text.y = element_text(size = 12)) + plot_layout(widths = c(2,1))
  
  pop_combo_plot
```

Readers may be especially interested in the simulated scenarios that produced negative MPA effects. The constant-catch fleet model was one of the most important drivers of extremely negative MPA effects, especially when both depletion and MPA size were in the 25-50% range (Fig.\@ref(fig:fleet-plot)). As the name implies, under the constant-catch fleet model fishing communities seek to catch the same amount regardless of the presence of an MPA. While this is an unlikely scenario to play out over the long term (and of course a average constant catch greater than MSY is not possible under the confines of this simulation framework), it is not a particularly outlandish scenario in the short-term. Subsistence fisheries may conform to a constant-catch style policy over the short term, as they seek to ensure the nutritional needs of their community. More industrial fisheries may have pre-arranged purchase orders for levels of catch. Quota managed fisheries may maintain relatively static quota levels until new stock assessments can be completed. 


```{r fleet-plot, fig.cap="Distribution of regional effects (measured as percentage of unfished biomass) as a function of mpa size (x-axis), depletion (facets) and fleet model (color)"}

short_term %>% 
  filter(depletion > 0) %>% 
  mutate(size = plyr::round_any(mpa_size, .25) %>% factor()) %>% 
  mutate(depletion = plyr::round_any(depletion, .25) %>% factor() ) %>% 
  filter(years_protected == 15) %>% 
  ggplot(aes(size, pop_effect, fill = fleet_model, color = fleet_model)) + 
  geom_violin() + 
  scale_y_continuous(labels = percent, name = "Regional Effect") +
  facet_wrap(~depletion, labeller = "label_both") + 
  labs(x  = "MPA Size")

```


## Detecting MPA outcomes

**How in depth do we want to go here (both in the body and in the "SI")? **

This is just brainstorming text here

At the simplest level, we do what I have here, which is just think through obvious shortcomings of the DiD analysis (e.g. if management besides MPA changes, or if parallel trends violated post treatment)

Beyond that, we can do a simple power analysis, thinking about for a given sample size, what is the highest variance that could exist around the mean to detect a given effect size (where "detect" means reject from zero). Somewhat appealing, but really abstract; what's the "sample size" we have (every transect? one per species per year)? What's a "reasonable" variance around the mean effect in a real system?

At the more complex level, I have a simulator built up where observers collect length comps from the data given various degrees of evolving skill etc. Can use it to demonstrate that a) the proposed identification strategy works just great under ideal circumstances, but that b) under even slightly realistic circumstances (stochastic auto-correlated recruitment with environmental forcing, evolving observer skill, different life history) you're back to selection on observables. I think this is probably an important point that warrants fleshing out, but it's challenging to implement well. How valuable do we feel that this step is?

```{r}

effect_size = expand.grid(
  mean = seq(0.01, 0.25, by = 0.01),
  sample_size = seq(5, 100, length.out = 100),
  cv = seq(.1, 2, length.out = 10)
  ) %>% 
  mutate(sd = mean*cv) %>% 
  mutate(samples = pmap(list(
    mean = mean,
    n = sample_size,
    sd = sd
  ),
  rnorm)) %>% 
  mutate(ttest = map_dbl(samples, ~t.test(.x)$p.value))
  

# effect_size %>% 
#   ggplot(aes(sample_size, ttest, color = sd)) + 
#   geom_point()

```


## Detecting MPA Effects in the Channel Islands

```{r}
y15 <- short_term %>% filter(years_protected == 15, mpa_size <= 0.25, depletion > 0.5)

```


Theory and simulation testing indicate then that while the regional effects of MPAs can range from strongly negative to highly positive, with the bulk of scenarios producing 0-10% regional effects after fifteen years of protection (though much more negative and much more positive outcomes are certainly possible). Given this, we can guess *a priori* that the "true" regional effect will be challenging to isolate from the variation both in the natural system and in any MPA monitoring program. We use data from the Partnership for Interdisciplinary Studies of Coastal Oceans (PISCO) monitoring of the Channel Islands National Marine Sanctuary to test our ability to detect the regional effect of MPAs in a real world context. PISCO conducts visual underwater SCUBA surveys at a variety of sites inside and outside of MPAs throughout the Channel Islands. At the rawest level, the data are counts of finfish in 2cm length bins along a 30m x 2m transect at various sites and depths. These length bins are converted to biomass, and then densities, by converting length to weights using available allometric data and dividing by the transect area. Our goal then is to estimate the effect of the MPAs on these densities of fish throughout the Channel Islands. 

Our identification strategy for this case study is to use unfished species as our control for unaccounted for environmental trends before and after MPA implementation (in 2003). The model estimates the difference in the trends between fished and unfished species post MPA (see nice infographic here). We fit this model using a hierarchical mixed-effect framework using Template Model Builder [TMB, @Kristensen2016] in R [@RCoreTeam2018]. The model consists broadly of three levels, the first (starting from the "bottom") being transect-level densities of fish species observed by PISCO, which are standardized into an index of biomass abundance to account for both probability of detection and expected density as a result of both abundance and changes in covariates such as observer skill [see @Maunder2004]. For the second stage, we break the abundance indices into targeted and non-targeted species (per the classifications in the PISCO data), and estimate the mean trend of each group (targeted and non-targeted) over time. In the third step, we estimate the difference in the mean trend between the targeted and non-targeted fishes, which under the right set of circumstances should reflect the causal effect of the MPAs on the outcome of interest (in this case regional biomass density of targeted fishes). 

The regional effect is incorporated into the model as follows. While individual species in the survey have their own abundance trends, the model assumes that abundance of targeted and non-targeted species each come from a common distribution. Assuming parallel pre-treatment trends, which visual (Fig.\@ref(fig:raw-trend)) and statistical (Fig.\@ref(fig:did-plot)) assessment do not rule out, the trend in the underlying mean abundance of non-targeted species post MPA serves as our control for unobserved environmental variables that could also affect the trends in the mean density of targeted species. So, by this logic, we should see no significant divergence between the targeted and non-targeted abundance trends pre "treatment" (implementation of the MPAs), and then some divergence between the treated group (targeted species) and the non-treated group (non-targeted) post treatment (if the treatment has an effect). 

Under these idealized circumstances, the magnitude of this divergence between the treated (targeted) and non-treated (non-targeted) groups post treatment is an estimate of the causal effect of the treatment (the implementation of MPAs). It is important to consider under what exactly this model controls for (and what it does not). Under the parallel trends assumption, we assume that both the targeted and non-targeted fishes respond the same way to non-modeled environmental drivers. For example, the Channel Islands region experienced a major El Niño event from 2014 to 2016. While we include variables like temperature and kelp cover in our model, these are clearly not the only factors affected by El Niño. However, if the parallel trends assumption is correct, the El Niño effects that are not explicitly included in the model are controlled for by the trend of the non-targeted fishes. 

However, this clearly does not control for differences in responses to non-modeled variables between the treated and non-treated groups. For example, the model contains data from the pre-MPA years of 2000 to 2002. The parallel trends assumption appears plausible over that time period (Fig.\@ref(fig:did-plot)). But, this pre-treatment period does not include an El Niño, while the post-treatment period does. Therefore, while the parallel trends assumption looks plausible from the pre-treatment data, it is possible that targeted and non-targeted fishes respond in a systematically different manner to El Niño, therefore violating the parallel trends assumption and invalidating the "causal" interpretation of the model. Similarly, the model cannot account for additional shocks to  the targeted species beyond the MPAs. For example, while we control for total landings of each targeted species in the Santa Barbara region, it is possible that within that region fishing effort became increasingly concentrated around the Islands, driving down local densities of fished species. The model cannot control for this unless the appropriate data are correctly incorporated into the model explicitly. 

The model also assumes that the targeted and non-targeted fishes do not directly affect each other. This assumption is clearly violated on some level: all the fishes in this analysis are part of the same ecosystem and therefore interact on some level. For example, if the protection of fished predatory fishes results in increased mortality of non-targeted fishes, the model would attribute that as an increased regional effect (greater divergence between the abundance of targeted and non-targeted species). Given the time scale of analysis (15 years of protection), we do not feel that massive trophic cascades are likely to have developed yet (XX, citation on time to trophic cascades), and there is little evidence of negative correlations between individual targeted and non-targeted fishes in the data (XX).

The proposed identification strategy serves to control for some unobserved factors influencing densities of targeted and non-targeted species, but is unlikely to account for all of them. Before examining regression results, we can graphically examine the trends in mean densities for targeted and non-targeted species over time. We centered and scaled the mean annual densities for each species included in the analysis in order to compare the trends across species groups. Grouping the species by targeted and non-targeted status, we see evidence of pre-treatment parallel trends in the abundance indices, and of a divergence post MPA implementation. Beginning in around 2007 abundances of targeted species appear to start increasing faster than non-targeted species. However, from 2012 onward abundances of targeted species appear to be declining relative to the trend in the non-targeted species. Not controlling for any other factors that may affect fish abundances, the data suggests a possible increase in targeted species abundance (relative to the "control" trend of the non-targeted species) at first, followed by a decrease in the most recent years (Fig.\@ref(fig:raw-trend)). 

```{r raw-trend, fig.cap="Centered and scaled mean annual density of included species (points) and smoothed means of targeted and non-targeted groups (line) over time"}
base_run$data[[1]] %>% 
  select(year, targeted,classcode, log_density, any_seen) %>% 
  mutate(density = exp(log_density) * any_seen) %>% 
  group_by(classcode,targeted, year) %>% 
  summarise(md = mean(density)) %>% 
  group_by(classcode,targeted) %>% 
  mutate(smd = (md - mean(md)) / sd(md)) %>% 
  ggplot(aes(year, smd, color = targeted == 1, fill = targeted == 1)) + 
  geom_vline(aes(xintercept = 2003), linetype = 2, color = "red") +
  geom_line(aes(group = interaction(targeted, classcode)), alpha = 0.25) +
  geom_smooth() + 
  scale_color_d3(name = "Targeted?") + 
  scale_fill_d3(name = "Targeted?") +
  labs(y = "Centered and Scaled Mean Density", x = "Year")

  
```


Turning to our regression results, We do not detect a significant change in the density of targeted fishes relative to the density of non-targeted fishes following the implementation of MPAs in the Channel Islands in 2003 (Fig.\@ref(fig:did-plot)). The mean estimated post MPA implementation divergence between the trends of targeted and non-targeted species was `r round(mean(did_betas$estimate))`, indicating a roughly 0% divergence. However, it is important to note that just because we cannot a reject a hypothesis of zero divergence between the targeted and non-targeted groups does not mean that we have precisely estimated the effect size to be zero. Post implementation, the upper limit of the estimated 95% confidence intervals was `r round(max(did_betas$upper),2)` , and the lower limit was `r round(min(did_betas$lower),2)`. XX Expand here a bit XX  


```{r did-plot, fig.cap = "Estimated divergence in densities of fished and unfished species in the Channel Islands. MPAs are implement in 2003 (red dashsed line). Estimates are from a regression on log(abundnace), and estimated effects roughyl correspond to percentage changes"}

did_plot + labs(y = "Estimate of Regional Effect")

```


## Discussion

MPAs are playing a growing role in the management of marine resources around the world. While the primary purpose of MPAs is often to protect species and habitats within their borders, they are also looked to to provide spillover benefits to the ecosystems and fisheries surrounding them. The existence and magnitude of these spillover benefits has been a source of substantial debate for a some time, with the bulk of the conversation centered around qualitative or theoretical examinations of particular drivers of spillover [citations], or in detecting empirical evidence of the existence of spillover [citations], but not the net regional effects of MPAs. As many of the MPA networks around the world become mature enough for analysis, it is critical that we take a step to consider what evidence we can expect to observe, and what we have in fact seen in natural systems. 

While a large body of literature has discussed the factors affecting the regional-scale conservation outcomes of MPAs [citations], we know of no other study that has synthesized much of the key theory predictions of the literature into a comprehensive simulation framework to address the cumulative impact of these drivers on the regional effects of MPAs. Our results present several important insights for understanding what we might expect the effects of MPAs outside their borders to be. First, we see that incorporating a broad, but still limited, set of life history, MPA and fishery characteristics produces a vast array of potential regional effects, from actual net conservation losses (in cases for example of short-term constant-catch, moderate pre-MPA depletion, and smaller MPA sizes), to massive conservation gains (e.g large MPAs in a very depleted fishery). These wide ranges of outcomes persisted even in extreme cases though; small effects were possible in very depleted fisheries, and larger effects were possible in cases of moderate depletion. One important result of this analysis is that looking across the range of "smaller" MPAs (covering 25% or less of the region), the median regional effect size was relatively small, both in percentage gains relative to the without-MPA scenario, and in percentage of unfished biomass recovered, up until the fishery was strongly depleted (Fig.\@ref(fig:f-and-s-plot)-\@ref(fig:pop-f-and-s-plot)).

This has important implications for our ability to empirically detect these effects in natural systems. Marine environments are complex and noisy systems, subject to both large amounts of natural variation and measurement error. Our simulation results suggest then that it will be relatively difficult to detect the regional-scale effects of MPAs in many cases of smaller MPAs and moderately depleted fisheries; separating out say the median simulated population effect of a `r median(short_term$pop_effect)`% of unfished biomass is a difficult task even in a carefully studied environment. With that in mind then, we should not be surprised that our analysis was unable to determine a clear regional divergence between the densities of targeted and non-targeted species throughout the Channel Islands in the 15 years since the newest set of MPAs were implemented in that region. 


What can we then infer about the regional effects of the Channel Island MPAs based on the available data and our analysis? At the simplest level, we cannot detect a significant divergence in densities of targeted and non-targeted fishes over the 15 years since the implementation of MPAs in the Channel Islands. However, it is important to note that we also cannot say that there has been no divergence. The 95% confidence intervals surrounding our year-to-year estimates of the divergences have a mean range of XX, and cross zero in every year (indicating that both positive and negative divergences have support from the data). Since the regression model is a log-linear model (predicting log density indices), we can interpret the the "divergence" coefficients roughly as percentage differences in the densities of targeted and non-targeted. The upper end of of our estimated confidence intervals corresponds to a roughly XX% increase in densities of targeted species relative to non-targeted, while at the lower end a XX% decrease is possible. Within these ranges though, the mean effect size was XX%, which corresponds closely with the median MPA effects predicted by our simulation analysis for moderately exploited species protected by a reserve network covering ~25% of the region's area. 

Do these estimated divergences represent the regional effect of the MPAs? There are clear reasons why we might think not: differences in responses to environmental drivers such as El Niño between targeted and non-targeted species, as well as non-MPA related fishery changes, are both plausible and capable of distorting our results. Trophic interactions could also positively (if increases in targeted predators drive down densities of herbivorous non-targeted species for example) or negatively (if MPA mediated trophic cascades result in increases in both targeted and non-targeted densities) bias our results. However, while these concerns are important, they are not sufficient cause to dismiss our strategy for estimating the regional conservation effects of MPAs outright. 

First, the assumptions of our identification strategy and operating models (e.g. no trophic interactions) reflect the underlying assumptions of much of the theoretical and simulation based literature on MPA effects used to motivate much of modern MPA design [@Fulton2015; @Gaines2010]. This of course does not mean that these assumptions are correct, but dismissing our results purely on the basis of for example the potential for trophic interactions requires then that we also rethink much of the work on which MPA design is based. All else being equal, most standard models of MPA effects would predict faster and more substantial changes in densities of targeted fishes post MPA implementation than for non-targeted species, which is exactly what our model is designed to detect. 

Second, our identification strategy is an improvement over the alternatives that are likely to be available in most cases. We could simply compare regional densities of fish before and after MPA implementation. Doing so in the case of the Channel Islands suggests that, controlling for observable covariates, densities of targeted species have declined substantially post-MPA [Fig.\@ref(fig:obs-plot)]. The reason we are skeptical of such a finding though is of course that other non-MPA factors for which we do not have adequate data to include in the model could be driving that decline. The relatively parallel pre-MPA trends in densities of targeted and non-targeted species suggests that this is indeed the case. We would of course prefer some form of control group rather than simply before-after comparisons. However, for all but the most specialized of cases we are unlikely to ever have effective spatio-temporal controls for MPAs (e.g. an MPA-less carbon-copy of the Channel Islands). Given these constraints then, measuring the regional divergence in targeted and non-targeted species is likely to be among the best available options for empirically estimating the region-wide conservation effects of MPAs given the kinds of data that are often collected in conjunction with MPAs (transect surveys inside and outside of reserves). 

Our estimated regional divergences in the densities of targeted and non-targeted fishes present an imperfect but improved (relative to alternative options) window into the regional effects of the Channel Islands MPAs. Our results leverage the evidence of parallel trends between the targeted and non-targeted fishes to refute the conclusion of post-MPA declines in densities we would reach if we simply looked at pre-and-post MPA densities of targeted species. But we also do not find clear evidence for substantial increases in densities of targeted species, relative to the trend we would expect given the densities of the non-targeted species. We do see some evidence for an increasing trend in targeted densities from 2003 to 2014, but this period is followed by signs of decreases from 2015 onward. Both the magnitude and direction of these changes are plausible effects of MPAs, according to our simulation analysis, but given the potential for confounding factors such as differences in environmental responses and changes fishery dynamics we cannot confidently attribute either the upward or downward trend directly to the MPAs. Rather, our results provide an improved framing for the plausible range of regional conservation effects of the MPAs. XX Refine this: can't justifiably say that the MPAs caused the recent decrease, but if we don't like the decrease we can't credit them for the increase, but does suggest that they weren't enough to offset it, still possible that they would have declined more without the MPAs, but given the best available controls we have no real way of proving that...XX

Despite the vast amount of rigorous data collection before and after, our identification strategy was unable to identify a clear signal of the effect of MPAs on the regional densities of targeted species. Our simulation analysis indicates though that we should not be surprised by this. The Channel Islands MPAs cover approximately 21% of the waters in the Channel Islands, and while formal stock assessments are not available for many of the targeted species in our analysis what evidence we have does not suggest they as a group they are heavily overfished [XX citations]. Our simulation analysis would suggest then that the percentage difference in densities of targeted species with and without MPAs should be on the smaller end (10% or less), and therefore be challenging to detect given the natural variable of marine ecosystems and the error inherent in visual survey programs such as those the PISCO data used here. What then does this suggest for the design and monitoring of MPAs?


Real world-policy making is inherently an exercise in utilizing best available theory, experience, and modeling to make decisions that are often difficult or practically impossible to empirically test. Despite our best efforts we are unlikely to ever truly "know" the effect of our efforts to mitigate climate change, but must instead rely on comparisons to best available modeling outcomes to understand how effective our policies have been [XX, is this a good argument?]. Similarly, given the complexities of marine systems much of our decisions on MPA design will have to be based on effective modeling. While we are hardly the first to point out that bio-economic models are a critical tool for MPA design, our results help indicate a minimum floor of model complexity to provide candid assessments of regional MPA effects. While factors such as MPA size and degree of depletion are especially strong drivers, for all but the most extreme cases of each a wide array of effects, from negative to highly positive,  are possible based on the complex interaction of factors such as fleet dynamics, movement rates, and recruitment timing. Confronting these interactions by considering the likely parameter space for a given region is a critical step then in understanding what likely regional effects of MPAs are. While models such as ours do require large numbers of parameters that may be challenging to obtain, our results show that working with communities to confront these uncertainties is preferable to sweeping them under the rug in favor of simpler models that are easier to parameterize but miss details that our results show can have dramatic effect on expected outcomes. Where possible, more advanced models than the one presented here should certainly be explored, but for communities that do not have the resources to do so we present a user-friendly application for conducting MPA simulations using our model [here](insert_link_to_shiny_app).

Modeling effort such as this can then provide stakeholders with some idea of the range of regional effect sizes that might be expected for a given MPA network design, and in doing so design monitoring programs targeted at the species and fleets that modeling suggests may provide the clearest indication of MPA mediated effects. For cases where bio-economic modeling suggests small potential for MPA driven regional density effects, monitoring efforts can be targeted around detecting potential negative effects should they arise... XX work on this. Smaller effect sizes will require more and better data to detect.. what else? Make case for why well funded and well designed monitoring is critical given difficulties of detection, need pre and postXX

Lastly, better integration of MPAs into stock assessment may help. Collect sufficient data to estimate a region-wide F, and see if it has gone up, down, or stayed the same post MPA. But critical to account for the size structure/densities inside and outside the MPA. From a population perspective [@Field2006]

We focus exclusively on regional conservation gains in this paper. However, fisheries spillover is often another important factor to consider (i.e. are fisheries better off with the MPAs than they would have been without them). The fishery benefits of MPAs are just as (and likely more) intensely debated than the regional conservation outcomes [citations; @Hilborn2004]. While we do not address fishery outcomes here, our results do highlight potential tradeoffs on regional conservation and fishery outcomes. Our analysis suggest that relatively large MPAs may be needed to increase the probability of achieving substantial increases in population sizes relative to unfished biomass. However, other analyses have suggested that near-term fishery benefits are maximized at smaller MPA sizes [@Ovando2016a; @Brown2015]. Our analysis lays the groundwork for an interesting synthesis study examining the parameter space of fishery and MPA characteristics the support both regional conservation and fishery gains. 

MPAs are an important part of the marine resource management toolbox... fisheries, tourism, habitat, resilience, climate, etc. But despite their simple appearance, predicting and detecting their regional conservation effects is far from simple. **Insert catchy closing statement**

# Methods

## Simulation Model

The simulation model used in this analysis is roughly the same as the one described in @Ovando2016a. It is an age structured, spatially explicit, bio-economic model. Recruitment is assumed to have Beverton-Holt dynamics on average, though auto-correlated log-normal recruitment deviates can be specified. The timing of density dependence can be one of five forms presented in @Babcock2011, ranging from independent density dependence in each patch to density dependence in a shared larval stage across patches. The model allows for both adult and larval movement, where larval movement is assumed to follow a Gaussian dispersal kernel based on the distance of each patch to the source patch. Adult movement is also modeled using a Gaussian dispersal kernel, but with the added option of density dependent movement as well. In the adult density dependent movement scenario we calculate the density gradient between each patch and every other patch, where the density gradient is calculated as

$$g_{i,j} = \frac{b_i}{b_i^0} - \frac{b_j}{b_j^0} + 1$$

Where *i* is the source patch and *j* is a sink patch, and $b^0$ is the unfished biomass in a given patch. The density gradient $g_{i,j}$ is used as a multiplicative modifier for the distance-based Gaussian dispersal kernel *d*, so that the net movement *m* of individuals from patch *i* to patches 1:J is

$$m_{i,j} = \frac{d_{i,j}g_{i,j}}{\sum_{1:J}d_{i,j}g_{i,j}} $$

Fishing activity is controlled by a fleet model that can take one of four forms: constant catch, constant effort, and open-access. For the constant effort and constant catch scenarios, a specified effort or catch level is set to achieve a target level of pre-MPA depletion, and that effort or catch is held constant post-MPA. For the open-access scenario, we model effort through a profit-response function, where profits are calculated per

$$profits_{t} \sim p_{t}q_{t}E_{t}B^{c}_{t} - c_{t}E_{t}^{\beta}$$

And then effort is modeled as 

$$effort_{t} = effort_{t-1} + effort_{msy}(\theta\frac{profits_{t-1}}{profits_{msy}})$$

The operating model allows for time-varying and auto-correlated deviations in prices *p*, cost *c*, and catchability *q*. For all fleet model scenarios, effort is distributed in space in one of two manners: divided equally among all fish-able patches, and distributed in proportion to historic profits in each patch. 

MPAs are implemented in the operating model by setting a specified percentage of the patches to be placed in a no-take MPA. Patches are then assigned to an MPA either in a linear fashion (left to right) or assigned at random throughout the patches. In all scenarios MPAs are implemented halfway through the simulated time series (allowing the pre-MPA fishing mortality to deplete the population to a desired level beforehand).

Using this operating model, we simulated MPA effects across 20,000 fisheries, where the regional effect is modeled by running the exact same fishery simulation with and without MPAs, and then calculating the difference in biomass in each year between the two scenarios (setting identical seeds for each simulation). The range of evaluated scenarios is presented in Table.XX

XX insert table of model runs XX


## Regression Analysis

```{r}

filter_summary <- fitted_data %>% 
  select(classcode, targeted) %>% 
  unique() %>% 
  group_by(targeted) %>% 
  count() %>% 
  ungroup() %>% 
  mutate(targeted = ifelse(targeted == 1,"yes","no")) %>% 
  spread(targeted, n)
```

The regression analysis is a mixed-effects hierarchical model. The raw data are estimated length compositions by fish species along a transect at a site. Lengths are converted to biomass per allometric relationships supplied by PISCO (see SI for summaries of the raw data). We performed some minimal data filtering to reduce noise in the data. We only include species that were observed at least twice in each year of the dataset (2000-2017) somewhere in the core Channel Islands (Anacapa, Santa Cruz, Santa Rosa, San Miguel). While some data are available from 1999, per consultation with PISCO we omit those data due to changes in survey protocols. We assign species to targeted and non-targeted groups per the PISCO classifications. This filtering process results in `r filter_summary$no` non-targeted species and `r filter_summary$yes` targeted species remaining in the analysis. 

The first stage of the regression is a delta log-normal hurdle model. The model estimates two regressions, the first is a binomial generalized linear model (GLM) with a logit link estimating the probability of observing a given fish species at a observation *i* (transect at time *t*). The probability that a given species was observed *o* at a given observation is distributed

$$o_{s,i} \sim binomial(\frac{1}{1 +e^{-\beta^{o}{X}}}) $$
 where $\beta^{o}$ are the estimated coefficients for the observation model and *X* is a matrix of covariates that include random effects for each year in the data (2000 to 2017). 
 
 The expected density *d* of positive observations is modeled per a log-normal distribution
 
 $$log(d_{s,i}) \sim normal(\beta^{d}X, \sigma_s)$$

where $\beta^{d}$ are the estimated coefficients for the expected density model and *X* is the same matrix of covariates as used in the observation portion of the model and $\sigma_s$ allows for each species *s* to have different standard deviations. 

X contains both fixed and random effects. Fixed effects include the level of the transect, the sampling site, the month of the observation, the estimated surge at the transect, visibility, the depth of the transect, and the experience (and experience squared) of the diver conducting the transect. We classify each species into one of two clusters based on the mean longitude the species was encountered at, breaking the species into two groups: those primarily found in the western end of the Channel Islands those found more in the eastern end.  We then estimate random effects for each island for each cluster

$$\beta_{island,cluster} \sim normal(0,\sigma_{cluster})$$

This allows the mean effect of each island to differ for each cluster, e.g. allowing the San Miguel, the eastern most island, to have a higher mean density for eastern species than for more western species (if the data suggest it). 

The second critical component of the covariate matrix *X* are random effects for each year for each species

$$\beta_{year,species} \sim normal(0,\sigma_{species})$$

These $\beta_{year,species}$ represent our "standardized" estimate of observed abundance of each species in each time step, controlling for the included covariates. 

However, we still need to account for changes in the probability of detection over time. For that, we create a standard matrix of with rows equal to the number of years and columns corresponding to each of the columns in *X*, holding everything fixed at mean (or most frequently observed level for factors) levels for all variables in X except for the year and species interaction indices. Calling this standardized matrix $X^{standard}$, the probability of observing a given species in year *y* is then

$$p_{s,y} = (\frac{1}{1 +e^{-\beta^{o}{X^{standard}}}})$$

In the same manner as described by @Punt2000, The standardized index of abundance for species *s* in year *y* then is

$$I_{species,year} = p_{species,year}e^{\beta_{species,year}}$$

The next phase of the model requires us to estimate the mean abundance of targeted and non-targeted species over time. The concept here is that each $I_{species,year}$ can be modeled by a regression that contains random effects for each year for targeted and non-targeted fishes, the assumption then being that there is a mean density for targeted and non-target species, and $I_{species,year}$ represent deviations from that mean. 

$$log(I_{species,year}) \sim normal(\beta^{effect}X^{effect}, \sigma_I)$$

$X^{effect}$ contains both fixed and random effects. The fixed effects include an intercept and the temperature deviation for a given species in a year, where temperature deviation is

$$t_{s,y} = (t^{pref}_{s} -  \bar{t_{y}})^2$$

where $t^{pref}$ is the preferred temperature for species *s* (drawn form `FishLife`, @Thorson2017d), and $\bar{t_{y}}$ is the mean temperature encountered by that species in year *y*. We also include as variables in the model the mean kelp cover experienced by a given species in a given year, as well as the total fishery catches reported in the previous year for that species in the Santa Barbara region [drawn from the California Department of Fish and Wildlife database].  We also include random intercepts for each species in $X^{effect}$. The most important random effects are year effects for targeted and non-targeted species

$$\beta_{year,targeted} \sim normal(0,\sigma_{targeted})$$

$\beta_{year,targeted}$ is the mean log density of targeted species in year *y*, controlling for included covariates. Therefore, the final step in the model, the divergence in the standardized abundance trends of targeted and non-targeted species is

$$divergence_{year} =  \beta_{year,targeted = 1} - \beta_{year,targeted = 0}$$

The model is fit in TMB to integrate the uncertainty across all levels of the model, with standard errors for each coefficient in the model estimated through the Laplace approximation. 

```{r fe-plot, fig.cap = "Estimated coefficients for non-spatial fixed effects in observation model (seeing) and observed model (seen)"}

 non_nested_beta_plot <- betas %>%
   filter(str_detect(group, "non_nested") & !str_detect(variable, "site_side")) %>%
   ggplot() +
   geom_hline(aes(yintercept = 0), linetype = 2, color = "red") +
   geom_pointrange(aes(x = variable,
                       y = estimate,
                       ymin = lower,
                       ymax = upper)) +
   facet_wrap(~group) +
   coord_flip() +
   theme(axis.text.y = element_text(size = 10))

non_nested_beta_plot

```


```{r site-plot, fig.cap = "Estimated coefficients for spatial fixed effects in observation model (seeing) and observed model (seen)"}

 non_nested_site_beta_plot <- betas %>%
   filter(str_detect(group, "non_nested") & str_detect(variable, "site_side")) %>%
  mutate(variable = tolower(variable)) %>% 
  mutate(variable = str_replace(variable, "site_side","")) %>% 
   ggplot() +
   geom_hline(aes(yintercept = 0), linetype = 2, color = "red") +
   geom_pointrange(aes(x = variable,
                       y = estimate,
                       ymin = lower,
                       ymax = upper)) +
   facet_wrap(~group) +
   coord_flip() +
   theme(axis.text.y = element_text(size = 10))

non_nested_site_beta_plot + 
  theme(axis.text.y = element_text(size = 6))

```

```{r region-plot, fig.cap="Random effects for region by cluster"}

  region_cluster_plots <- betas %>%
   filter(str_detect(group, "region_cluster_betas")) %>%
   mutate(cluster = str_replace_all(variable,"\\D","")) %>%
   mutate(region = str_split(variable,'-', simplify = T)[,3]) %>%
   ggplot() +
    geom_hline(aes(yintercept = 0), linetype = 2, color = "red") +
    geom_pointrange(aes(x = region,
                        y = estimate,
                        ymin = lower,
                        ymax = upper, color = cluster)) +
    facet_wrap(~group)

region_cluster_plots

```


```{r targ-plot, fig.cap = "Trends in standardized mean abundance of targeted and non-targeted species"}

targeted_trends <- report$zissou_estimates %>% 
  filter(str_detect(variable, "targeted_did")) %>% 
  group_by(variable) %>% 
  mutate(year = unique(fitted_data$year)) %>% 
  ungroup() %>% 
  ggplot() + 
  geom_line(aes(year, estimate, color = variable),alpha = 0.5) +
  geom_pointrange(aes(year, estimate, ymin = lower, ymax = upper, color = variable)) + 
scale_color_d3(name = "Targeted?") 


targeted_trends

```


# Supplementary Materials

## Regression Diagnostics


```{r}

fit_report <- base_run$tmb_fit[[1]]$zissou_report

observed_seen <- base_run$tmb_fit[[1]]$zissou_data$log_density
  
observed_seeing <- base_run$tmb_fit[[1]]$zissou_data$any_seen

seen_diagnostics <- data_frame(observed = observed_seen, predicted = as.numeric(fit_report$log_density_hat)) %>% 
  mutate(residuals = predicted - observed)


seeing_diagnostics <- data_frame(observed = observed_seeing, predicted = as.numeric(fit_report$prob_seeing)) 

```


```{r}

a = base_run$tmb_fit[[1]]$seen_cdata$x_non_nested %>% 
  select(contains("mean_")) %>% 
  mutate(resid = seen_diagnostics$residuals) %>% 
  gather(variable, value, -resid) %>% 
  ggplot(aes(value, resid)) + 
  geom_point() + 
  facet_wrap(~variable)

a

```


```{r obs-v-pred, fig.cap="High level diagnostics for observed compontent of Delta-GLM: Observed vs predicted log densities (A), predicted log density vs residuals (B), and a normal qq-plot of the residuals (C)"}

obs_v_pred <- seen_diagnostics %>% 
  ggplot(aes(observed, predicted)) + 
  geom_point(alpha = 0.5) + 
  geom_abline(aes(intercept = 0, slope = 1), linetype = 2, color = "red") + 
  labs(caption = glue::glue("R^2 is {round(yardstick::rsq(data = seen_diagnostics, truth = observed, estimate = predicted),2)}"), title= "A") + 
  theme(plot.margin = unit(rep(.1,4), units = "lines"))

fit_v_resid <- seen_diagnostics %>% 
  ggplot(aes(predicted, residuals)) + 
  geom_point() + 
  geom_hline(aes(yintercept = 0), linetype = 2, color = "red") + 
  labs(title = "B") +
    theme(plot.margin = unit(rep(.1,4), units = "lines"))

qq_plot <- ggplot(seen_diagnostics, aes(sample = residuals)) +
  stat_qq() +
  stat_qq_line() + 
  labs(title = "C") + 
    theme(plot.margin = unit(rep(.1,4), units = "lines"))


obs_v_pred/(fit_v_resid + qq_plot)


```



```{r, fig.cap = "Binned mean predicted probability of detection vs observed proportion of positive detections"}
seeing_diagnostics %>% 
  ungroup() %>% 
  mutate(binned_prob = ntile(predicted, 20)) %>% 
  arrange(binned_prob) %>% 
  group_by(binned_prob) %>% 
  summarise(mean_prob_seen = mean(predicted),
            percent_observed = mean(observed))  %>% 
  ggplot() +
  geom_point(aes(mean_prob_seen, percent_observed)) + 
  geom_abline(aes(intercept = 0, slope = 1), color = "red", linetype = 2) + 
  labs(x = "Binned Predicted Probability of Detection", y = "Proportion of Positive Observations")
  
```


## Additional Things

```{r neg-tree, fig.cap =  "Classification tree of positive MPA effects as a function of simulation traits"}

short_term$positive_effect <- (short_term$pop_effect > 0) %>% as.factor()

negative_tree = train(positive_effect ~ factor(fleet_model) + adult_movement + larval_movement + depletion + mpa_size + factor(density_dependence_form) + density_movement_modifier,
       method = "rpart", 
       data =  short_term %>% filter(years_protected == 15))

plot(negative_tree$finalModel, uniform=TRUE)
text(negative_tree$finalModel, use.n=TRUE, all=TRUE, cex=.4)

```

data coverage

```{r, fig.cap = "Spatio-temporal sampling intensity. Points are sampling sites, size and opacity indicate number of years that site has been sampled. Color indicates whether the site is in an eventual MPA site"}

site_summary <- pisco_data %>% 
  left_join(site_data, by = c("site","side")) %>% 
    filter(region %in% c("ANA","SCI","SRI","SMI")) %>% 
  group_by(site) %>% 
  summarise(nobs = length(log_density),
            nyears = n_distinct(year),
            pre_mpa = min(year) < 2003,
            post_mpa = max(year) > 2003,
            lat = mean(lat_wgs84, na.rm = T),
            long = mean(lon_wgs84, na.rm = T),
            mpa = unique(eventual_mpa))

ggmap::qmplot(long, lat, size = nyears, alpha = nyears, color = mpa, data = site_summary) + 
  theme_minimal()

```


Is there evidence that we should be treating each island as its own population?

```{r reg-pop, fig.cap = "Mean density by island by year for each species included in the analysis"}

fitted_data %>% 
  group_by(region, year, classcode) %>% 
  summarise(mean_density = mean(exp(log_density))) %>% 
  mutate(log_mean_density = log(mean_density)) %>% 
  ungroup() %>% 
  ggplot(aes(year, mean_density, color = region)) + 
  geom_line() + 
  facet_wrap(~classcode, scales = "free_y") + 
  theme_minimal()


```


Do the standardized abundance indices change the story completely relative to to averaging out the zeros and simply looking at the raw mean densities each year? Not really. 

```{r raw-v-stand-plot, fig.cap = "Raw (points) and standardized (lines) indices of abundance for each of the species included in the analysis"}



life_history <- fitted_data %>%
  select(classcode) %>%
  unique() %>%
  mutate(numeric_classcode = as.numeric(as.factor(classcode)))

raw <- fitted_data %>%
  group_by(year, classcode, targeted) %>%
  summarise(md = mean(exp(log_density)),
            mt = mean(temp_deviation)) %>%
  group_by(classcode) %>%
  mutate(smd = (md - mean(md))/(sd(md))) %>%
  ungroup() %>%
  left_join(life_history, by = "classcode")

years <- unique(fitted_data$year)

abundance_trends <- data_frame(abundance_hat = fit_report$abundance_hat,
                               classcode = rep(1:n_distinct(fitted_data$classcode), each = length(years))) %>%
  mutate(log_abundance_hat = log(abundance_hat)) %>%
  group_by(classcode) %>%
  mutate(year = 1999 + 1:length(abundance_hat)) %>%
  mutate(scaled_abundance_hat = (abundance_hat - mean(abundance_hat)) / sd(abundance_hat)) %>%
  ungroup() %>%
  rename(numeric_classcode = classcode) %>%
  left_join(life_history, by = "numeric_classcode" )


# 
# abundance_trends %>%
#   ggplot(aes(year, log(abundance_hat), color = factor(classcode))) +
#   geom_line(show.legend = F) +
#   geom_vline(aes(xintercept = 2003), linetype = 2, color = "red") +
#   facet_wrap(~classcode) +
#   theme_minimal()

abundance_trends %>%
  ggplot(aes(year, scaled_abundance_hat, color = factor(classcode))) +
  geom_line(show.legend = F) +
  geom_vline(aes(xintercept = 2003), linetype = 2, color = "red") +
  geom_point(data = raw,aes(year, smd, color = factor(classcode)), show.legend = F)+
  facet_wrap(~classcode) +
  theme_minimal()

```



Dealing with "missing" observations is a critical challenge in any field observation study. If no observations of a given fish species were recorded on a given transect, should the density of that species on that transect be marked as zero, and influence the estimate of the overall mean density accordingly? The obvious answer seems to be yes, but what if that species simply does not live in the environment covered by a particular transect? For our base runs, we assign a value of zero density on a given transect for any fish species that has been observed at least once at a given site at any time in our data but was not observed on that particular transect. If that species was never observed at that site, we do not include a zero for that species. Our rationale for this is that given the shifting nature of the sampled sites, and the intensity of sampling at those sites, we do not want to skew density trends by changes in the amount of suitable habitat for a given species sampled. However, this is clearly a strong assumption. For example, perhaps the decreasing trend in mean densities from 2000 to 2004 is due to increased number of sites (and therefore zeros) included in the data. To assess the potential importance of this choice, we can compare the mean densities of targeted and non-targeted species over time with the added zeros (Fig.\@ref(fig:raw-trend)) to the mean densities using only positive observations (i.e. not including any zeros in the data, (Fig.\@ref(fig:nozero-raw-trend)). The trends in the raw densities, and most importantly the mean trends of targeted and non-targeted fishes, are nearly identical whether or not zeros are included, providing strong evidence that our choice of how to incorporate missing observations into the data are not strongly influencing our overall results. 

```{r nozero-raw-trend, fig.cap = "Centered and scaled mean annual density, excluding zeros, of included species (points) and smoothed means of targeted and non-targeted groups (line) over time" }

base_run$data[[1]] %>% 
  filter(any_seen == T) %>% 
  select(year, targeted,classcode, log_density, any_seen) %>% 
  mutate(density = exp(log_density) * any_seen) %>% 
  group_by(classcode,targeted, year) %>% 
  summarise(md = mean(density)) %>% 
  group_by(classcode,targeted) %>% 
  mutate(smd = (md - mean(md)) / sd(md)) %>% 
  ggplot(aes(year, smd, color = targeted == 1, fill = targeted == 1)) + 
  geom_vline(aes(xintercept = 2003), linetype = 2, color = "red") +
  geom_line(aes(group = interaction(targeted, classcode)), alpha = 0.25) +
  geom_smooth() +
  scale_color_d3(name = "Targeted?") + 
  scale_fill_d3(name = "Targeted?") +
  labs(y = "Centered and Scaled Mean Density", x = "Year")


```

We include a variety of environmental, observation, and temporal indicators in our model. Inclusion of highly co-linear variables in a model can inflate standard errors and obscure "true" effects. To account for this we calculated the Pearson's correlation coefficients for all of the continuous data included in our model to ensure that none of the included variables had correlation coefficients greater than 0.7, a general rule of thumb for co-inclusion of variables [citation]. We did not find problematic levels of correlation among any of our included continuous variables. 

```{r numeric-cor, fig.cap="Pearson correlation coefficients of continuos data included in the regression model"}

base_run$data[[1]] %>% 
  select_if(is.numeric) %>% 
  select(-log_density,-targeted) %>% 
  na.omit() %>% 
  corrr::correlate() %>% 
  gather("colname","correlation",-rowname) %>% 
  ggplot(aes(rowname, colname,fill = correlation)) + 
  geom_tile() + 
  geom_text(aes(rowname, colname, label = round(correlation,2))) + 
  scale_fill_gradient2(low = "tomato", mid = "white", high = "steelblue", midpoint = 0, limits = c(-1,1)) + 
  theme(axis.text.x = element_text(angle = 45, vjust = .5),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) 
  
  

```


## Selection on Observables

Our proposed identification strategy attempts to control for non-MPA (and not directly modeled) related changes in abundances through the trend in the non-targeted species. However, a simpler alternative would be to simply compare densities before-and-after MPA implementation, while explicitly controlling for non-MPA related factors that we believe may have some effect on densities (a "selection on observables" strategy). To that end, we fit a mixed-effects regression that models log densities (of positive observations only for simplicity's sake here) as a function of temperature deviations, kelp cover, observer experience, random effects for species and region, and fixed effects for each year in the data (omitting the year 2000). 

Using this model, densities of targeted species appear to have been declining steadily since 2000, and appear to have plateaued off since the implementation of MPAs in 2003. Without an identification strategy such as the one employed in this study then, all we could conclude is that densities appear to be lower post-MPA, and have not increased substantially over time (Fig.\@ref(fig:obs-plot)).  


```{r obs-plot, fig.cap = "Selection on observables identification strategy. Plotted estiamtes are fixed effects on of year on log-density (relative to the year 2000), controlling for observer experience, temperature deviations, and kelp cover, with random effects for species and region"}

test <- lme4::lmer(log_density~ factor_year + cumulative_n_obs  + temp_deviation + interp_kelp + (1|classcode) + (1|region), data = fitted_data %>% filter(targeted == 1, any_seen == T))

broom::tidy(test) %>% 
  filter(str_detect(term, "factor_year")) %>% 
  mutate(year = str_replace_all(term,"\\D","") %>% as.numeric()) %>% 
  ggplot() + 
  geom_vline(aes(xintercept = 2003), linetype = 2, color = "red") +
  geom_pointrange(aes(year, estimate, ymin = estimate - 1.96*std.error, ymax = estimate + 1.96*std.error)) + 
  labs(y = "Estimated Difference", x = "Year")

```

## Repeat basic analysis. 

This analysis has a LOT of complicated moving parts. It's worth taking a step back and keeping it simple though: what does a simple classic difference in difference analysis say? i.e. `targeted + year + year:targeted`, aggregating up the densities to take care of the zeros. Results reflect the basic trends seen in the crazy complex analysis, but with much broader error bars (Fig.\@ref(fig:basic-plot)). The take home message here is that all the complicated business helps dial in the results a bit, but is not fundamentally changing the story from a simpler analysis. 

```{r, include=F}
raw <- fitted_data %>%
  group_by(year, classcode, region, targeted) %>%
  summarise(md = mean(exp(log_density)),
            mt = mean(temp_deviation)) %>%
  group_by(classcode) %>%
  mutate(smd = (md - mean(md))/(sd(md))) %>%
  ungroup() %>%
  left_join(life_history, by = "classcode")

raw_region <- fitted_data %>%
  group_by(year, region,classcode, targeted) %>%
  summarise(md = mean(exp(log_density)),
            mt = mean(temp_deviation)) %>%
  group_by(classcode) %>%
  mutate(smd = (md - mean(md))/(sd(md))) %>%
  ungroup() %>%
  left_join(life_history, by = "classcode")


raw_mpa_only <- fitted_data %>%
  filter(eventual_mpa == T) %>% 
  group_by(year, classcode, targeted) %>%
  summarise(md = mean(exp(log_density)),
            mt = mean(temp_deviation)) %>%
  group_by(classcode) %>%
  mutate(smd = (md - mean(md))/(sd(md))) %>%
  ungroup() %>%
  left_join(life_history, by = "classcode")

raw_nompa_only <- fitted_data %>%
  filter(eventual_mpa == F) %>% 
  group_by(year, classcode, targeted) %>%
  summarise(md = mean(exp(log_density)),
            mt = mean(temp_deviation)) %>%
  group_by(classcode) %>%
  mutate(smd = (md - mean(md))/(sd(md))) %>%
  ungroup() %>%
  left_join(life_history, by = "classcode")

basic_model <- rstanarm::stan_glm(log(md + 1e-3) ~ factor(year) + targeted + factor(year):targeted, data = raw)


```


```{r basic-plot, fig.cap = "Simple DiD using aggregate Density Data"}



basic_plot <- basic_model %>% 
  broom::tidy() %>% 
  filter(str_detect(term, ":targeted")) %>% 
  mutate(year = str_replace_all(term,"\\D","") %>% as.numeric()) %>% 
  ggplot() + 
  geom_hline(aes(yintercept = 0),linetype = 2, color = "black") +
  geom_vline(aes(xintercept = 2003),linetype = 2, color = "red") +
  geom_pointrange(aes(year, estimate, ymin = estimate - 1.96*std.error,
                      ymax = estimate + 1.96*std.error))

basic_plot

```

```{r, eval = F}
basic_modeler <- rstanarm::stan_glmer(log(md + 1e-3) ~ factor(year) + targeted + factor(year):targeted + (1|classcode), data = raw)


basic_plus_model <- rstanarm::stan_glm(log(md + 1e-3) ~ factor(year) + targeted + factor(year):targeted + mt, data = raw)


basic_plus_mpa_model <- rstanarm::stan_glm(log(md + 1e-3) ~ factor(year) + targeted + factor(year):targeted + mt, data = raw_mpa_only)

basic_plus_nompa_model <- rstanarm::stan_glm(log(md + 1e-3) ~ factor(year) + targeted + factor(year):targeted + mt, data = raw_nompa_only)


basic_plus_region_model <- rstanarm::stan_glm(log(md + 1e-3) ~ factor(year) + targeted + factor(year):targeted + mt, data = raw_region)



basic_plot <- basic_modeler %>% 
  broom::tidy() %>% 
  filter(str_detect(term, ":targeted")) %>% 
  mutate(year = str_replace_all(term,"\\D","") %>% as.numeric()) %>% 
  ggplot() + 
  geom_hline(aes(yintercept = 0),linetype = 2, color = "black") +
  geom_vline(aes(xintercept = 2003),linetype = 2, color = "red") +
  geom_pointrange(aes(year, estimate, ymin = estimate - 1.96*std.error,
                      ymax = estimate + 1.96*std.error))

basic_plus_plot <- basic_plus_model %>% 
  broom::tidy() %>% 
  filter(str_detect(term, ":targeted")) %>% 
  mutate(year = str_replace_all(term,"\\D","") %>% as.numeric()) %>% 
  ggplot() + 
  geom_hline(aes(yintercept = 0),linetype = 2, color = "black") +
  geom_vline(aes(xintercept = 2003),linetype = 2, color = "red") +
  geom_pointrange(aes(year, estimate, ymin = estimate - 1.96*std.error,
                      ymax = estimate + 1.96*std.error))

basic_plus_mpa_plot <- basic_plus_mpa_model %>% 
  broom::tidy() %>% 
  filter(str_detect(term, ":targeted")) %>% 
  mutate(year = str_replace_all(term,"\\D","") %>% as.numeric()) %>% 
  ggplot() + 
  geom_hline(aes(yintercept = 0),linetype = 2, color = "black") +
  geom_vline(aes(xintercept = 2003),linetype = 2, color = "red") +
  geom_pointrange(aes(year, estimate, ymin = estimate - 1.96*std.error,
                      ymax = estimate + 1.96*std.error))


basic_plus_region_plot <- basic_plus_region_model %>% 
  broom::tidy() %>% 
  filter(str_detect(term, ":targeted")) %>% 
  mutate(year = str_replace_all(term,"\\D","") %>% as.numeric()) %>% 
  ggplot() + 
  geom_hline(aes(yintercept = 0),linetype = 2, color = "black") +
  geom_vline(aes(xintercept = 2003),linetype = 2, color = "red") +
  geom_pointrange(aes(year, estimate, ymin = estimate - 1.96*std.error,
                      ymax = estimate + 1.96*std.error))


 <- raw %>% 
  ungroup() %>% 
  ggplot(aes(year, md, color = targeted == 1, fill = targeted == 1)) + 
  geom_point(data = raw %>% group_by(year, targeted) %>% summarise(lmmd = (mean(md))), aes(year, lmmd, color = targeted == 1)) +
  geom_vline(aes(xintercept = 2003), linetype = 2, color = "red") +
  geom_smooth()


dropgrid <- expand.grid(targeted = unique(fitted_data$classcode[fitted_data$targeted == 1]),
            nontargeted = unique(fitted_data$classcode[fitted_data$targeted == 0]), stringsAsFactors = F) %>%
  as_data_frame()
  
  drops <- map2(dropgrid$targeted,dropgrid$nontargeted, ~c(.x,.y))

raw_mpa_story <- raw_mpa_only %>% 
  ungroup() %>% 
  ggplot(aes(year, md, color = targeted == 1, fill = targeted == 1)) + 
  geom_point(data = raw %>% group_by(year, targeted) %>% summarise(lmmd = (mean(md))), aes(year, lmmd, color = targeted == 1)) +
  geom_vline(aes(xintercept = 2003), linetype = 2, color = "red") +
  geom_smooth()

raw_nompa_story <- raw_nompa_only %>% 
  ungroup() %>% 
  ggplot(aes(year, md, color = targeted == 1, fill = targeted == 1)) + 
  geom_point(data = raw %>% group_by(year, targeted) %>% summarise(lmmd = (mean(md))), aes(year, lmmd, color = targeted == 1)) +
  geom_vline(aes(xintercept = 2003), linetype = 2, color = "red") +
  geom_smooth()


```

# Works Cited